<!-- admin/admin.html (FINAL) -->
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LevPay Admin</title>
  <meta name="color-scheme" content="dark" />
  <style>
    :root{
      --bg0:#060812; --bg1:#0b1024;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --bd: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --mut: rgba(255,255,255,.65);
      --mut2: rgba(255,255,255,.45);
      --ok: rgba(34,197,94,1);
      --warn: rgba(249,115,22,1);
      --bad: rgba(239,68,68,1);
      --pri1: rgba(124,58,237,1);
      --pri2: rgba(34,211,238,1);
      --r1: 18px; --r2: 24px;
      --shadow: 0 18px 44px rgba(0,0,0,.40);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0; color:var(--txt); font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(124,58,237,.22), transparent 55%),
        radial-gradient(900px 700px at 80% 0%, rgba(34,211,238,.16), transparent 55%),
        radial-gradient(900px 700px at 20% 90%, rgba(34,197,94,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
    }

    .wrap{ width:min(1100px, 94vw); margin: 26px auto 56px; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; margin-bottom:16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:42px; height:42px; border-radius:16px;
      background: linear-gradient(135deg, rgba(124,58,237,.9), rgba(34,211,238,.9));
      box-shadow: 0 14px 34px rgba(34,211,238,.18);
      display:grid; place-items:center;
      font-weight:1100;
      color:#08101f;
    }
    .title h1{ margin:0; font-size:18px; letter-spacing:-.02em; font-weight:1000; }
    .title p{ margin:2px 0 0; color:var(--mut); font-size:12px; font-weight:800; }

    .pill{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.05);
      font-weight:1000; font-size:12px;
      display:inline-flex; align-items:center; gap:8px;
    }
    .dot{ width:9px; height:9px; border-radius:99px; background: rgba(148,163,184,.9); }
    .dot.ok{ background: rgba(34,197,94,.95); }
    .dot.bad{ background: rgba(239,68,68,.95); }
    .dot.warn{ background: rgba(249,115,22,.95); }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
    }
    @media (max-width: 940px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      border-radius: var(--r2);
      border: 1px solid var(--bd);
      background: linear-gradient(180deg, rgba(255,255,255,.065), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHead{
      padding: 16px 16px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .cardHead h2{ margin:0; font-size:14px; font-weight:1100; color: rgba(255,255,255,.9); }
    .cardHead .sub{ color:var(--mut); font-size:12px; font-weight:900; }
    .cardBody{ padding: 14px 16px 16px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1; min-width: 180px; }
    .label{ display:block; margin: 8px 0 8px; color: var(--mut); font-size:12px; font-weight:1000; }
    .input, .select{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      padding: 12px 12px;
      font-weight:900;
      outline:none;
    }
    .input::placeholder{ color: rgba(255,255,255,.35); font-weight:800; }
    .hint{ color: var(--mut2); font-size:12px; line-height:1.55; margin-top:8px; font-weight:800; }

    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      border:none;
      border-radius: 16px;
      padding: 12px 12px;
      font-weight:1100;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .12s ease, filter .12s ease, opacity .12s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btn.primary{
      color:#08101f;
      background: linear-gradient(90deg, var(--pri1), var(--pri2));
      box-shadow: 0 14px 34px rgba(34,211,238,.16);
    }
    .btn.ghost{
      color: var(--txt);
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.12);
    }
    .btn.bad{
      color: rgba(255,255,255,.92);
      background: rgba(239,68,68,.15);
      border: 1px solid rgba(239,68,68,.32);
    }

    .table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .table th, .table td{
      padding: 10px 10px;
      font-size:12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      vertical-align: top;
    }
    .table th{
      text-align:left; color: rgba(255,255,255,.78); font-weight:1100;
      background: rgba(255,255,255,.04);
    }
    .table tr:last-child td{ border-bottom:none; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-weight:1000;
      white-space:nowrap;
    }
    .badge.ok{ border-color: rgba(34,197,94,.30); background: rgba(34,197,94,.10); }
    .badge.bad{ border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }
    .mono{ font-family: var(--mono); font-size: 12px; }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      width: min(560px, 92vw);
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,13,22,.92);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      display:none;
      z-index: 99;
      color: var(--txt);
      font-weight: 900;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    .toast.is-on{ display:flex; }
    .toast small{ color: var(--mut); font-weight: 900; }
    .toast button{
      border:none;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      color: var(--txt);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 1000;
    }

    /* ---- LOCK OVERLAY ---- */
    .lock{
      position: fixed;
      inset:0;
      display:grid;
      place-items:center;
      background: rgba(0,0,0,.25);
      backdrop-filter: blur(12px);
      z-index: 100;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease;
    }
    .lock.is-on{
      opacity:1;
      pointer-events:auto;
    }
    .lockPanel{
      width: min(560px, 92vw);
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(10,13,22,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .lockHead{
      padding: 16px 16px 10px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .lockHead .h{ font-weight: 1100; }
    .lockBody{ padding: 14px 16px 16px; }
    .krow{ display:flex; gap:10px; flex-wrap:wrap; }
    .krow .input{ flex: 1; min-width: 200px; }
    .lockHint{
      margin-top:10px;
      color: var(--mut);
      font-size: 12px;
      line-height:1.6;
      font-weight: 900;
    }

    /* code box */
    .codeBox{
      margin-top:12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }
    .codeBoxHead{
      padding: 10px 12px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .codeBoxHead .t{ font-weight:1100; font-size:12px; color: rgba(255,255,255,.82); }
    .codeBox pre{
      margin:0;
      padding: 12px;
      overflow:auto;
      max-height: 360px;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(255,255,255,.88);
      white-space: pre;
    }

    .divider{ height: 12px; }

    .smallBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .mini{
      padding: 9px 10px;
      border-radius: 14px;
      font-size: 12px;
      font-weight: 1100;
    }

    .footNote{
      margin-top: 12px;
      color: var(--mut2);
      font-size: 12px;
      font-weight: 900;
      line-height: 1.6;
    }

  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">LV</div>
        <div class="title">
          <h1>LevPay Admin Panel</h1>
          <p id="envInfo">‚Äî</p>
        </div>
      </div>
      <div class="pill" id="connPill"><span class="dot warn" id="connDot"></span><span id="connText">Belum login</span></div>
    </div>

    <div class="grid">
      <!-- LEFT: Voucher + Monthly -->
      <div class="card">
        <div class="cardHead">
          <div>
            <h2>Voucher</h2>
            <div class="sub">Upsert / Disable / List / Get</div>
          </div>
          <button class="btn ghost mini" id="btnRefreshVouchers" type="button">Refresh</button>
        </div>
        <div class="cardBody">
          <div class="row">
            <div class="col">
              <label class="label">Code</label>
              <input class="input" id="v_code" placeholder="KINGLEV" />
            </div>
            <div class="col">
              <label class="label">Name</label>
              <input class="input" id="v_name" placeholder="KINGLEV 60%" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label class="label">Percent (0-100)</label>
              <input class="input" id="v_percent" type="number" min="0" max="100" step="1" placeholder="60" />
            </div>
            <div class="col">
              <label class="label">Max Rp (0 = unlimited)</label>
              <input class="input" id="v_maxRp" type="number" min="0" step="1" placeholder="0" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label class="label">Max Uses (kosong = unlimited)</label>
              <input class="input" id="v_maxUses" type="number" min="0" step="1" placeholder="(optional)" />
            </div>
            <div class="col">
              <label class="label">ExpiresAt (ISO / kosong)</label>
              <input class="input mono" id="v_expiresAt" placeholder="2026-12-31T23:59:59.000Z" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label class="label">Enabled</label>
              <select class="select" id="v_enabled">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
            <div class="col">
              <label class="label">Note (optional)</label>
              <input class="input" id="v_note" placeholder="catatan admin" />
            </div>
          </div>

          <div class="btnRow">
            <button class="btn primary" id="btnVoucherUpsert" type="button">Save / Upsert</button>
            <button class="btn bad" id="btnVoucherDisable" type="button">Disable</button>
            <button class="btn ghost" id="btnVoucherGet" type="button">Get</button>
            <button class="btn ghost" id="btnVoucherList" type="button">List</button>
          </div>

          <div class="divider"></div>

          <table class="table" id="voucherTable">
            <thead>
              <tr>
                <th>Code</th>
                <th>Status</th>
                <th>Percent</th>
                <th>MaxRp</th>
                <th>Uses / MaxUses</th>
                <th>Expires</th>
                <th>Pick</th>
              </tr>
            </thead>
            <tbody id="voucherTbody">
              <tr><td colspan="7" style="color:rgba(255,255,255,.55);font-weight:900">Belum ada data. Klik ‚ÄúRefresh‚Äù.</td></tr>
            </tbody>
          </table>

          <div class="footNote">
            Tips: klik <b>Pick</b> biar field auto terisi, lalu bisa <b>Disable</b> atau edit & <b>Upsert</b>.
          </div>
        </div>
      </div>

      <!-- RIGHT: Monthly + Device tools + Discount tester -->
      <div>
        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Monthly Promo</h2>
              <div class="sub">1√ó per device per bulan</div>
            </div>
            <button class="btn ghost mini" id="btnMonthlyGet" type="button">Get</button>
          </div>
          <div class="cardBody">
            <div class="row">
              <div class="col">
                <label class="label">Enabled</label>
                <select class="select" id="m_enabled">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <div class="col">
                <label class="label">Name</label>
                <input class="input" id="m_name" placeholder="PROMO BULANAN" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label class="label">Percent (0-100)</label>
                <input class="input" id="m_percent" type="number" min="0" max="100" step="1" placeholder="5" />
              </div>
              <div class="col">
                <label class="label">MaxRp</label>
                <input class="input" id="m_maxRp" type="number" min="0" step="1" placeholder="2000" />
              </div>
            </div>

            <div class="row">
              <div class="col">
                <label class="label">Require Code</label>
                <select class="select" id="m_requireCode">
                  <option value="false">false</option>
                  <option value="true">true</option>
                </select>
                <div class="hint">Kalau true, monthly cuma jalan kalau voucher input = code monthly.</div>
              </div>
              <div class="col">
                <label class="label">Monthly Code (optional)</label>
                <input class="input" id="m_code" placeholder="MONTHLYVIP" />
                <div class="hint">Dipakai kalau requireCode=true. Kode ini fleksibel dari admin page.</div>
              </div>
            </div>

            <div class="btnRow">
              <button class="btn primary" id="btnMonthlySet" type="button">Save Monthly</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Device Tools</h2>
              <div class="sub">Generate deviceId + helper untuk unlimited monthly</div>
            </div>
          </div>
          <div class="cardBody">
            <label class="label">Device ID Generator</label>
            <div class="row">
              <div class="col">
                <input class="input mono" id="dev_prefix" placeholder="dev_" value="dev_" />
                <div class="hint">Prefix bebas. Output deviceId random.</div>
              </div>
              <div class="col">
                <button class="btn primary" id="btnMakeDevice" type="button" style="width:100%">Create Device ID</button>
              </div>
            </div>

            <label class="label">Device ID</label>
            <input class="input mono" id="dev_id" placeholder="(hasil muncul di sini)" />

            <div class="smallBtns">
              <button class="btn ghost mini" id="btnCopyDevice" type="button">Copy DeviceId</button>
              <button class="btn ghost mini" id="btnMakeApplyCurl" type="button">Build Curl Apply</button>
            </div>

            <div class="codeBox" id="deviceCurlBox" style="display:none">
              <div class="codeBoxHead">
                <div class="t">Curl JSON</div>
                <div class="smallBtns" style="margin:0">
                  <button class="btn ghost mini" id="btnCopyDeviceCurl" type="button">Copy</button>
                </div>
              </div>
              <pre id="deviceCurlPre"></pre>
            </div>

            <div class="hint">
              Unlimited monthly: di API, logic unlimited pakai <b>deviceKey</b> (SHA256(deviceId + "|" + PEPPER)).
              Kalau nanti endpoint monthly.set lu support addUnlimitedDeviceKey, lu tinggal paste deviceKey ke situ.
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="cardHead">
            <div>
              <h2>Discount Tester</h2>
              <div class="sub">Test apply (public) biar yakin diskon jalan</div>
            </div>
          </div>
          <div class="cardBody">
            <div class="row">
              <div class="col">
                <label class="label">Amount</label>
                <input class="input" id="t_amount" type="number" min="1" step="1" value="10000" />
              </div>
              <div class="col">
                <label class="label">DeviceId</label>
                <input class="input mono" id="t_deviceId" placeholder="dev_test_1" />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label class="label">Voucher (optional)</label>
                <input class="input" id="t_voucher" placeholder="KINGLEV / MONTHLYVIP" />
              </div>
            </div>

            <div class="btnRow">
              <button class="btn primary" id="btnTestApply" type="button">Run discount.apply</button>
              <button class="btn ghost" id="btnCopyApplyCurl" type="button">Copy curl</button>
            </div>

            <div class="codeBox">
              <div class="codeBoxHead">
                <div class="t">Response</div>
                <div class="smallBtns" style="margin:0">
                  <button class="btn ghost mini" id="btnCopyResp" type="button">Copy</button>
                </div>
              </div>
              <pre id="respPre">{}</pre>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- LOCK SCREEN -->
  <section class="lock is-on" id="lock">
    <div class="lockPanel">
      <div class="lockHead">
        <div class="h">üîê Admin Login</div>
        <div class="pill"><span class="dot warn"></span><span>Need Admin Key</span></div>
      </div>
      <div class="lockBody">
        <label class="label">HOST</label>
        <input class="input mono" id="hostInput" placeholder="https://levpay-api.vercel.app" />
        <label class="label">Admin Key</label>
        <div class="krow">
          <input class="input mono" id="keyInput" placeholder="LEVIN6824" />
          <button class="btn primary" id="btnLogin" type="button">Unlock</button>
        </div>
        <div class="lockHint">
          Setelah unlock, panel kebuka (blur hilang) & semua request admin otomatis pakai header:
          <span class="badge"><span class="mono">X-Admin-Key</span></span>
        </div>
      </div>
    </div>
  </section>

  <!-- TOAST -->
  <div class="toast" id="toast">
    <div>
      <div id="toastMsg">‚Äî</div>
      <small id="toastSub"></small>
    </div>
    <button id="toastClose" type="button">OK</button>
  </div>

  <script>
    (() => {
      // ---------- helpers ----------
      const $ = (id) => document.getElementById(id);

      const toast = (() => {
        const el = $("toast");
        const msg = $("toastMsg");
        const sub = $("toastSub");
        const close = $("toastClose");
        let t = null;
        close.addEventListener("click", () => hide());

        function show(m, s="") {
          msg.textContent = String(m || "‚Äî");
          sub.textContent = String(s || "");
          el.classList.add("is-on");
          clearTimeout(t);
          t = setTimeout(hide, 2600);
        }
        function hide() { el.classList.remove("is-on"); }
        return { show, hide };
      })();

      const safeJson = (x) => {
        try { return JSON.stringify(x, null, 2); } catch { return String(x); }
      };

      const rand = (n=10) => {
        const abc = "abcdefghijklmnopqrstuvwxyz0123456789";
        let s = "";
        for (let i=0;i<n;i++) s += abc[Math.floor(Math.random()*abc.length)];
        return s;
      };

      function toBool(v){ return String(v) === "true"; }
      function toNum(v, fallback=null){
        if (v === "" || v == null) return fallback;
        const n = Number(v);
        return Number.isFinite(n) ? n : fallback;
      }

      async function copyText(text){
        try{
          await navigator.clipboard.writeText(String(text||""));
          return true;
        }catch{
          try{
            const ta = document.createElement("textarea");
            ta.value = String(text||"");
            ta.style.position="fixed"; ta.style.opacity="0";
            document.body.appendChild(ta);
            ta.focus(); ta.select();
            document.execCommand("copy");
            ta.remove();
            return true;
          }catch{ return false; }
        }
      }

      // ---------- session / auth ----------
      const LS = {
        host: "levpay_admin_host",
        key: "levpay_admin_key",
      };

      let HOST = "";
      let ADMIN_KEY = "";

      function setConn(ok, text){
        const dot = $("connDot");
        const label = $("connText");
        dot.classList.remove("ok","bad","warn");
        dot.classList.add(ok ? "ok" : "warn");
        label.textContent = text;
      }

      function setEnvInfo(){
        $("envInfo").textContent = HOST ? `HOST: ${HOST}` : "HOST belum di-set";
      }

      function unlock(){
        $("lock").classList.remove("is-on");
        setConn(true, "Admin unlocked");
        setEnvInfo();
      }

      function lock(){
        $("lock").classList.add("is-on");
        setConn(false, "Belum login");
        setEnvInfo();
      }

      function loadSaved(){
        HOST = localStorage.getItem(LS.host) || "";
        ADMIN_KEY = localStorage.getItem(LS.key) || "";
        $("hostInput").value = HOST || "https://levpay-api.vercel.app";
        $("keyInput").value = ADMIN_KEY || "";
        setEnvInfo();

        if (HOST && ADMIN_KEY) unlock();
        else lock();
      }

      $("btnLogin").addEventListener("click", async () => {
        const h = String($("hostInput").value || "").trim().replace(/\/+$/,"");
        const k = String($("keyInput").value || "").trim();
        if (!h || !k){
          toast.show("HOST & Admin Key wajib diisi");
          return;
        }

        // quick validate: call voucher.list (admin) to ensure key ok
        try{
          const r = await fetch(`${h}/api/levpay?action=voucher.list`, {
            method:"POST",
            headers:{
              "Content-Type":"application/json",
              "X-Admin-Key": k,
            },
            body: "{}",
          });
          const j = await r.json().catch(()=>null);
          if (!r.ok || !j || j.success === false){
            toast.show("Admin key salah / endpoint error", safeJson(j || {status:r.status}));
            return;
          }
          HOST = h;
          ADMIN_KEY = k;
          localStorage.setItem(LS.host, HOST);
          localStorage.setItem(LS.key, ADMIN_KEY);
          unlock();
          toast.show("Unlocked", "Admin key valid ‚úÖ");
          await refreshVouchers();
          await monthlyGet();
        }catch(e){
          toast.show("Gagal konek ke HOST", e?.message || "network error");
        }
      });

      // ---------- api wrappers ----------
      async function api(action, body={}, admin=false){
        if (!HOST) throw new Error("HOST kosong");
        const url = `${HOST}/api/levpay?action=${encodeURIComponent(action)}`;
        const headers = { "Content-Type":"application/json" };
        if (admin){
          headers["X-Admin-Key"] = ADMIN_KEY;
        }
        const res = await fetch(url, {
          method:"POST",
          headers,
          body: JSON.stringify(body || {}),
        });
        const data = await res.json().catch(()=> ({}));
        if (!res.ok || data?.success === false){
          const err = data?.error || `HTTP ${res.status}`;
          throw new Error(err);
        }
        return data;
      }

      // ---------- voucher ----------
      const v = {
        code: $("v_code"),
        name: $("v_name"),
        percent: $("v_percent"),
        maxRp: $("v_maxRp"),
        maxUses: $("v_maxUses"),
        expiresAt: $("v_expiresAt"),
        enabled: $("v_enabled"),
        note: $("v_note"),
      };

      function fillVoucherForm(x){
        if (!x) return;
        v.code.value = x.code || "";
        v.name.value = x.name || "";
        v.percent.value = x.percent ?? "";
        v.maxRp.value = x.maxRp ?? "";
        v.maxUses.value = (x.maxUses ?? "") === null ? "" : (x.maxUses ?? "");
        v.expiresAt.value = x.expiresAt || "";
        v.enabled.value = String(x.enabled !== false);
        v.note.value = x.note || "";
      }

      function voucherPayload(){
        const code = String(v.code.value||"").trim().toUpperCase();
        if (!code) throw new Error("code required");
        return {
          code,
          name: String(v.name.value||"").trim() || code,
          enabled: toBool(v.enabled.value),
          percent: toNum(v.percent.value, 0),
          maxRp: toNum(v.maxRp.value, 0),
          maxUses: v.maxUses.value === "" ? null : toNum(v.maxUses.value, null),
          expiresAt: String(v.expiresAt.value||"").trim() || null,
          note: String(v.note.value||"").trim() || null,
        };
      }

      async function voucherUpsert(){
        const body = voucherPayload();
        const out = await api("voucher.upsert", body, true);
        toast.show("Voucher disimpan", body.code);
        await refreshVouchers();
        return out;
      }

      async function voucherDisable(){
        const code = String(v.code.value||"").trim().toUpperCase();
        if (!code) throw new Error("code required");
        const out = await api("voucher.disable", { code }, true);
        toast.show("Voucher disabled", code);
        await refreshVouchers();
        return out;
      }

      async function voucherGet(){
        const code = String(v.code.value||"").trim().toUpperCase();
        if (!code) throw new Error("code required");
        const out = await api("voucher.get", { code }, true);
        fillVoucherForm(out.data);
        toast.show("Voucher loaded", code);
        return out;
      }

      async function refreshVouchers(){
        const tbody = $("voucherTbody");
        tbody.innerHTML = `<tr><td colspan="7" style="color:rgba(255,255,255,.55);font-weight:900">Loading‚Ä¶</td></tr>`;
        const out = await api("voucher.list", {}, true);
        const items = Array.isArray(out.data) ? out.data : [];
        if (!items.length){
          tbody.innerHTML = `<tr><td colspan="7" style="color:rgba(255,255,255,.55);font-weight:900">Belum ada voucher.</td></tr>`;
          return;
        }
        tbody.innerHTML = items.map((x) => {
          const ok = x.enabled !== false;
          const exp = x.expiresAt ? String(x.expiresAt) : "‚Äî";
          const maxUses = (x.maxUses ?? null) === null ? "‚àû" : x.maxUses;
          const uses = x.uses ?? 0;
          return `
            <tr>
              <td class="mono">${x.code || "‚Äî"}</td>
              <td>${ok ? `<span class="badge ok"><span class="dot ok"></span>enabled</span>` : `<span class="badge bad"><span class="dot bad"></span>disabled</span>`}</td>
              <td>${x.percent ?? 0}%</td>
              <td>${x.maxRp ?? 0}</td>
              <td>${uses} / ${maxUses}</td>
              <td class="mono">${exp}</td>
              <td><button class="btn ghost mini" type="button" data-pick="${x.code}">Pick</button></td>
            </tr>
          `;
        }).join("");

        tbody.querySelectorAll("[data-pick]").forEach(btn => {
          btn.addEventListener("click", async () => {
            const code = btn.getAttribute("data-pick");
            v.code.value = code;
            try{ await voucherGet(); }catch(e){ toast.show("Gagal get voucher", e.message); }
          });
        });
      }

      $("btnVoucherUpsert").addEventListener("click", async () => {
        try{ await voucherUpsert(); }catch(e){ toast.show("Upsert gagal", e.message); }
      });
      $("btnVoucherDisable").addEventListener("click", async () => {
        try{ await voucherDisable(); }catch(e){ toast.show("Disable gagal", e.message); }
      });
      $("btnVoucherGet").addEventListener("click", async () => {
        try{ await voucherGet(); }catch(e){ toast.show("Get gagal", e.message); }
      });
      $("btnVoucherList").addEventListener("click", async () => {
        try{ await refreshVouchers(); toast.show("Voucher list ok"); }catch(e){ toast.show("List gagal", e.message); }
      });
      $("btnRefreshVouchers").addEventListener("click", async () => {
        try{ await refreshVouchers(); toast.show("Refreshed"); }catch(e){ toast.show("Refresh gagal", e.message); }
      });

      // ---------- monthly ----------
      const m = {
        enabled: $("m_enabled"),
        name: $("m_name"),
        percent: $("m_percent"),
        maxRp: $("m_maxRp"),
        requireCode: $("m_requireCode"),
        code: $("m_code"),
      };

      function fillMonthly(x){
        if (!x) return;
        m.enabled.value = String(!!x.enabled);
        m.name.value = x.name || "";
        m.percent.value = x.percent ?? "";
        m.maxRp.value = x.maxRp ?? "";
        m.requireCode.value = String(!!x.requireCode);
        m.code.value = x.code || "";
      }

      async function monthlyGet(){
        const out = await api("monthly.get", {}, true);
        fillMonthly(out.data);
        toast.show("Monthly loaded");
        return out;
      }

      async function monthlySet(){
        const body = {
          enabled: toBool(m.enabled.value),
          name: String(m.name.value||"").trim() || "PROMO BULANAN",
          percent: toNum(m.percent.value, 0),
          maxRp: toNum(m.maxRp.value, 0),
          requireCode: toBool(m.requireCode.value),
          code: String(m.code.value||"").trim().toUpperCase() || null,
        };
        const out = await api("monthly.set", body, true);
        fillMonthly(out.data);
        toast.show("Monthly saved", body.requireCode ? `code: ${body.code||"(empty)"}` : "auto monthly");
        return out;
      }

      $("btnMonthlyGet").addEventListener("click", async () => {
        try{ await monthlyGet(); }catch(e){ toast.show("Monthly.get gagal", e.message); }
      });
      $("btnMonthlySet").addEventListener("click", async () => {
        try{ await monthlySet(); }catch(e){ toast.show("Monthly.set gagal", e.message); }
      });

      // ---------- device tools ----------
      $("btnMakeDevice").addEventListener("click", () => {
        const p = String($("dev_prefix").value||"dev_").trim() || "dev_";
        const id = `${p}${rand(10)}`;
        $("dev_id").value = id;
        $("t_deviceId").value = id; // also set tester
        toast.show("DeviceId dibuat", id);
      });

      $("btnCopyDevice").addEventListener("click", async () => {
        const id = $("dev_id").value;
        if (!id) return toast.show("DeviceId kosong");
        const ok = await copyText(id);
        toast.show(ok ? "Copied" : "Copy gagal", id);
      });

      function buildApplyCurl(){
        const amount = Number($("t_amount").value || 10000);
        const deviceId = String($("t_deviceId").value || $("dev_id").value || "dev_test_1").trim();
        const voucher = String($("t_voucher").value || "").trim();
        const payload = voucher
          ? { amount, deviceId, voucher }
          : { amount, deviceId };

        const curl =
`HOST="${HOST}"
curl -sS -X POST "$HOST/api/levpay?action=discount.apply" \\
  -H "Content-Type: application/json" \\
  -d '${JSON.stringify(payload)}' | jq`;

        return { curl, payload };
      }

      $("btnMakeApplyCurl").addEventListener("click", async () => {
        const id = $("dev_id").value;
        if (!id) return toast.show("Buat deviceId dulu");
        $("t_deviceId").value = id;
        const { curl } = buildApplyCurl();
        $("deviceCurlPre").textContent = curl;
        $("deviceCurlBox").style.display = "block";
        toast.show("Curl dibuat");
      });

      $("btnCopyDeviceCurl").addEventListener("click", async () => {
        const txt = $("deviceCurlPre").textContent;
        const ok = await copyText(txt);
        toast.show(ok ? "Curl copied" : "Copy gagal");
      });

      // ---------- discount tester ----------
      $("btnTestApply").addEventListener("click", async () => {
        try{
          const amount = Number($("t_amount").value || 0);
          const deviceId = String($("t_deviceId").value || "").trim();
          const voucher = String($("t_voucher").value || "").trim();
          if (!amount || amount < 1) return toast.show("Amount invalid");
          if (!deviceId) return toast.show("DeviceId wajib");

          const body = voucher ? { amount, deviceId, voucher } : { amount, deviceId };
          const out = await api("discount.apply", body, false);
          $("respPre").textContent = safeJson(out);

          const disc = out?.data?.discountRp ?? 0;
          const fin = out?.data?.finalAmount ?? null;
          toast.show("discount.apply OK", `discountRp=${disc} | final=${fin}`);
        }catch(e){
          $("respPre").textContent = safeJson({ success:false, error: e.message });
          toast.show("discount.apply gagal", e.message);
        }
      });

      $("btnCopyApplyCurl").addEventListener("click", async () => {
        const { curl } = buildApplyCurl();
        const ok = await copyText(curl);
        toast.show(ok ? "Curl copied" : "Copy gagal");
      });

      $("btnCopyResp").addEventListener("click", async () => {
        const txt = $("respPre").textContent;
        const ok = await copyText(txt);
        toast.show(ok ? "Response copied" : "Copy gagal");
      });

      // ---------- init ----------
      loadSaved();

      // If already unlocked, auto load data
      (async () => {
        try{
          if (HOST && ADMIN_KEY){
            await refreshVouchers();
            await monthlyGet();
          }
        }catch(e){
          // if key expired/wrong, relock
          lock();
          toast.show("Auto-load gagal", e.message);
        }
      })();
    })();
  </script>
</body>
</html>