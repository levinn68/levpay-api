<!-- admin/admin.html (CLEAN + "REAL ADMIN" LOOK)
  ✅ UI lebih rapih (nggak ada bayang-bayang aneh lebay)
  ✅ Background halus, card minimal, animasi smooth
  ✅ Endpoint TIDAK ditampilin
  ✅ Voucher code TIDAK ditampilin di list
  ✅ Voucher code di form disembunyiin (password) + tombol "Reveal" (opsional)
  ✅ Log/debug disanitasi (mask code & url)
  ✅ Generate 64 char = SHA-256 hex (aman, normal). DeviceId random beda-beda per generate.

  Router target: /api/orkut?action=...
  Admin header: X-Admin-Key: <key>
-->
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LevPay Admin</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --bd: rgba(255,255,255,.10);
      --txt: rgba(245,248,255,.92);
      --mut: rgba(245,248,255,.65);
      --mut2: rgba(245,248,255,.48);
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --pri: #7c3aed;
      --pri2:#22d3ee;
      --r: 18px;
      --r2: 24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --shadow: 0 14px 40px rgba(0,0,0,.35); /* lembut, gak kocak */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--txt);
      background:
        radial-gradient(900px 520px at 10% -20%, rgba(124,58,237,.22), transparent 60%),
        radial-gradient(900px 520px at 95% 0%, rgba(34,211,238,.16), transparent 55%),
        linear-gradient(180deg, #070a12, var(--bg));
      overflow-x:hidden;
    }
    @media (prefers-reduced-motion: no-preference){
      *{scroll-behavior:smooth}
    }

    /* LOCK BLUR (sebelum masuk admin key) */
    body.is-locked .app{
      filter: blur(10px);
      transform: scale(.992);
      opacity:.70;
      pointer-events:none;
      user-select:none;
      transition: filter .20s ease, transform .20s ease, opacity .20s ease;
    }
    body:not(.is-locked) .app{
      transition: filter .20s ease, transform .20s ease, opacity .20s ease;
    }

    /* Toast */
    .toast{
      position: fixed;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 80;
      padding: 10px 14px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.40);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      font-weight: 900;
      font-size: 12px;
      display:none;
      max-width: min(860px, 92vw);
      text-align:center;
    }
    .toast.is-on{display:block; animation: pop .16s ease both}
    @keyframes pop{from{transform:translateX(-50%) translateY(8px);opacity:0}to{transform:translateX(-50%) translateY(0);opacity:1}}

    /* Layout */
    .app{
      width: min(1280px, 96vw);
      margin: 20px auto 60px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){ .app{grid-template-columns:1fr} }

    /* Sidebar */
    .side{
      position: sticky;
      top: 16px;
      align-self: start;
      border-radius: var(--r2);
      border:1px solid var(--bd);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .side__head{
      padding: 16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .brand{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .brand h1{
      margin:0;
      font-size: 15px;
      font-weight: 1000;
      letter-spacing: -.02em;
    }
    .brand .sub{
      margin:0;
      font-size: 12px;
      color: var(--mut);
      font-weight: 900;
      line-height:1.5;
    }

    .nav{
      padding: 10px;
      display:grid;
      gap:8px;
    }
    .navBtn{
      width:100%;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: var(--txt);
      padding: 12px 12px;
      font-weight: 950;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .navBtn:active{transform: translateY(1px)}
    .navBtn.is-active{
      background: linear-gradient(90deg, rgba(124,58,237,.20), rgba(34,211,238,.12));
      border-color: rgba(34,211,238,.20);
    }
    .navBtn small{color:var(--mut2); font-weight:900}

    .side__foot{
      padding: 12px 10px;
      border-top:1px solid rgba(255,255,255,.06);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Main */
    .main{display:grid; gap:14px;}

    /* Topbar */
    .topbar{
      border-radius: var(--r2);
      border:1px solid var(--bd);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .topbar__inner{
      padding: 12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      gap:10px;
    }
    .pills{display:flex; gap:10px; flex-wrap:wrap}
    .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      font-weight: 950;
    }
    .pill .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25)}
    .pill[data-tone="ok"] .dot{background:var(--ok)}
    .pill[data-tone="warn"] .dot{background:var(--warn)}
    .pill[data-tone="bad"] .dot{background:var(--bad)}
    .pill small{color:var(--mut); font-weight:900}

    /* Panels */
    .panel{
      border-radius: var(--r2);
      border:1px solid var(--bd);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel__head{
      padding: 14px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .panel__head h2{
      margin:0;
      font-size: 14px;
      font-weight: 1000;
      letter-spacing: -.01em;
    }
    .panel__head .sub{
      margin-top:6px;
      color: var(--mut);
      font-weight: 900;
      font-size: 12px;
      line-height: 1.55;
    }
    .panel__body{padding: 14px 16px 16px}

    .grid2{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
    }
    @media (max-width: 1080px){ .grid2{grid-template-columns:1fr} }

    /* Inputs */
    label{
      display:block;
      margin: 4px 0 8px;
      color: var(--mut);
      font-weight: 950;
      font-size: 12px;
    }
    .input, select{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      padding: 12px 12px;
      outline:none;
      font-weight: 950;
      font-size: 14px;
    }
    .hint{
      margin-top:8px;
      color: var(--mut2);
      font-weight: 900;
      font-size: 12px;
      line-height: 1.55;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px){ .row{grid-template-columns:1fr} }

    /* Buttons */
    .btn{
      border:none;
      border-radius: 16px;
      padding: 11px 14px;
      font-weight: 1000;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}
    .btn--pri{
      color:#06101f;
      background: linear-gradient(90deg, var(--pri), var(--pri2));
    }
    .btn--ghost{
      color: var(--txt);
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
    }
    .btn--ok{
      color:#06150e;
      background: linear-gradient(90deg, var(--ok), var(--pri2));
    }
    .btn--bad{
      color:#24080a;
      background: linear-gradient(90deg, var(--bad), var(--warn));
    }
    .btn--mini{padding: 9px 10px; border-radius: 14px; font-size:12px}
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .hr{height:1px;background: rgba(255,255,255,.08); margin: 12px 0}

    /* Table */
    .tableWrap{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    table{width:100%; border-collapse:collapse; font-size:12px}
    thead{background: rgba(255,255,255,.05)}
    th,td{
      padding: 10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align: top;
    }
    th{
      text-align:left;
      color: var(--mut);
      font-weight: 1000;
      font-size: 11px;
      letter-spacing:.02em;
      text-transform: uppercase;
    }
    tbody tr{
      cursor:pointer;
      transition: background .12s ease;
    }
    tbody tr:hover{background: rgba(255,255,255,.04)}
    .right{text-align:right}
    .mono{font-family: var(--mono)}
    .mut{color: var(--mut)}
    .mut2{color: var(--mut2)}

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight: 1000;
      white-space:nowrap;
    }
    .badge .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,.22)}
    .badge[data-tone="ok"] .dot{background:var(--ok)}
    .badge[data-tone="bad"] .dot{background:var(--bad)}
    .badge[data-tone="warn"] .dot{background:var(--warn)}

    /* Sections */
    .section{display:none}
    .section.is-on{display:block; animation: fade .16s ease both}
    @keyframes fade{from{opacity:0; transform: translateY(6px)} to{opacity:1; transform:none}}

    /* Modal */
    .modal{
      position:fixed; inset:0;
      z-index:90;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.48);
      backdrop-filter: blur(14px);
    }
    .modal.is-on{display:grid}
    .modal__panel{
      width:min(560px, 94vw);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,13,22,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: in .16s ease both;
    }
    @keyframes in{from{transform: translateY(10px); opacity:0} to{transform:none; opacity:1}}
    .modal__head{
      padding: 14px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .modal__title{margin:0; font-weight:1000; font-size:14px}
    .modal__sub{margin-top:6px; color:var(--mut); font-weight:900; font-size:12px; line-height:1.55}
    .modal__body{padding: 14px 16px 16px}

    /* Debug box (sanitized) */
    .codeBox{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      padding: 12px 12px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.55;
      white-space: pre;
      overflow:auto;
      max-height: 320px;
    }

    /* Small reveal button inline */
    .inline{
      display:flex; align-items:center; gap:10px;
    }
    .grow{flex:1}
  </style>
</head>

<body class="is-locked">
  <div class="toast" id="toast">OK</div>

  <!-- LOGIN MODAL -->
  <div class="modal is-on" id="keyModal" aria-hidden="false">
    <div class="modal__panel">
      <div class="modal__head">
        <div>
          <h3 class="modal__title">Masuk Admin</h3>
          <div class="modal__sub">
            Masukkan <b>Admin Key</b> untuk akses panel.
            <div class="mut2" style="margin-top:6px">
              (Endpoint & kode voucher disembunyikan di UI biar aman.)
            </div>
          </div>
        </div>
        <button class="btn btn--ghost btn--mini" id="btnFillDemo" type="button">Isi contoh</button>
      </div>
      <div class="modal__body">
        <label>Base URL (opsional)</label>
        <input class="input" id="baseUrl" placeholder="Kosong = domain ini (same-origin)" />
        <div class="hint">Kalau admin ini satu domain sama API → kosongin aja.</div>

        <div class="hr"></div>

        <label>Admin Key</label>
        <input class="input" id="adminKey" type="password" placeholder="Masukkan Admin Key..." />
        <div class="hint">Key disimpan di <b>localStorage</b>. Logout untuk hapus.</div>

        <div class="btnRow">
          <button class="btn btn--pri" id="btnUnlock" type="button">Masuk</button>
          <button class="btn btn--ghost" id="btnPing" type="button">Ping</button>
        </div>

        <div class="hr"></div>
        <div class="hint">
          Kalau ping OK tapi key salah → biasanya <b>ADMIN_KEY</b> server beda.
        </div>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- Sidebar -->
    <aside class="side">
      <div class="side__head">
        <div class="brand">
          <h1>LevPay Admin</h1>
          <p class="sub">Voucher & Monthly settings</p>
        </div>
      </div>

      <div class="nav">
        <button class="navBtn is-active" data-tab="tab-voucher">
          <span>Voucher</span><small>›</small>
        </button>
        <button class="navBtn" data-tab="tab-monthly">
          <span>Monthly</span><small>›</small>
        </button>
        <button class="navBtn" data-tab="tab-tools">
          <span>Tools</span><small>›</small>
        </button>
        <button class="navBtn" data-tab="tab-debug">
          <span>Debug</span><small>›</small>
        </button>
      </div>

      <div class="side__foot">
        <button class="btn btn--ghost btn--mini" id="btnPingTop" type="button">Ping</button>
        <button class="btn btn--ghost btn--mini" id="btnRefreshAll" type="button">Refresh</button>
        <button class="btn btn--ghost btn--mini" id="btnLogout" type="button">Logout</button>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <div class="topbar">
        <div class="topbar__inner">
          <div class="pills">
            <div class="pill" id="pillApi" data-tone="warn"><span class="dot"></span><span id="pillApiText">API: belum dicek</span></div>
            <div class="pill" id="pillKey" data-tone="warn"><span class="dot"></span><span id="pillKeyText">Key: belum</span></div>
            <div class="pill" id="pillV" data-tone="warn"><span class="dot"></span><span id="pillVText">Voucher: —</span></div>
            <div class="pill" id="pillM" data-tone="warn"><span class="dot"></span><span id="pillMText">Monthly: —</span></div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn btn--ghost btn--mini" id="btnNewVoucher" type="button">New Voucher</button>
            <button class="btn btn--ghost btn--mini" id="btnLoadVouchers" type="button">Load List</button>
          </div>
        </div>
      </div>

      <!-- Voucher -->
      <section class="section is-on" id="tab-voucher">
        <div class="panel">
          <div class="panel__head">
            <div>
              <h2>Voucher Manager</h2>
              <div class="sub">List voucher (tanpa nampilin kode). Klik row untuk edit.</div>
            </div>
          </div>

          <div class="panel__body">
            <div class="grid2">
              <!-- List -->
              <div>
                <div class="row">
                  <div>
                    <label>Search (name / note)</label>
                    <input class="input" id="qSearch" placeholder="Cari nama voucher..." />
                  </div>
                  <div>
                    <label>Filter</label>
                    <select class="input" id="qFilter">
                      <option value="on">ON saja</option>
                      <option value="off">OFF saja</option>
                      <option value="all">Semua</option>
                    </select>
                  </div>
                </div>

                <div class="btnRow">
                  <button class="btn btn--ghost btn--mini" id="btnSortName" type="button">Sort: NAME</button>
                  <button class="btn btn--ghost btn--mini" id="btnSortUpdated" type="button">Sort: UPDATED</button>
                </div>

                <div class="hr"></div>

                <div class="tableWrap">
                  <table>
                    <thead>
                      <tr>
                        <th style="width:110px">Status</th>
                        <th>Name</th>
                        <th class="right">%</th>
                        <th class="right">MaxRp</th>
                        <th class="right">Uses</th>
                        <th style="width:160px">Expires</th>
                      </tr>
                    </thead>
                    <tbody id="voucherTbody">
                      <tr><td colspan="6" class="mut">Belum ada data. Klik <b>Load List</b>.</td></tr>
                    </tbody>
                  </table>
                </div>

                <div class="hint">
                  Kalau voucher “ON tapi gak kepotong” di frontend pembayaran:
                  biasanya frontend nembak <b>base URL yang beda</b>, atau voucher payload key beda.
                  Panel ini test pakai createqr biar sama flow.
                </div>
              </div>

              <!-- Form -->
              <div>
                <div class="panel" style="border-radius: var(--r2)">
                  <div class="panel__head">
                    <div>
                      <h2>Edit Voucher</h2>
                      <div class="sub">
                        Tips cepat: diskon 90% tapi kepotong kecil → biasanya <b>maxRp</b> kepasang (cap).
                      </div>
                    </div>
                    <div id="editBadge" class="badge" data-tone="warn"><span class="dot"></span><span>Idle</span></div>
                  </div>

                  <div class="panel__body">
                    <div class="row">
                      <div>
                        <label>Kode (disembunyikan)</label>
                        <div class="inline">
                          <input class="input grow" id="vCode" type="password" placeholder="(hidden)" autocomplete="off" />
                          <button class="btn btn--ghost btn--mini" id="btnRevealCode" type="button">Reveal</button>
                        </div>
                        <div class="hint">Kode nggak ditampilin di list. Reveal hanya kalau butuh.</div>
                      </div>
                      <div>
                        <label>Enabled</label>
                        <select class="input" id="vEnabled">
                          <option value="true">true</option>
                          <option value="false">false</option>
                        </select>
                      </div>

                      <div>
                        <label>Nama</label>
                        <input class="input" id="vName" placeholder="VIP LEVEL" />
                      </div>
                      <div>
                        <label>Diskon %</label>
                        <input class="input" id="vPercent" type="number" min="0" max="100" step="1" placeholder="90" />
                      </div>

                      <div>
                        <label>MaxRp (0 = unlimited)</label>
                        <input class="input" id="vMaxRp" type="number" min="0" step="1" placeholder="0" />
                      </div>
                      <div>
                        <label>MaxUses (kosong = unlimited)</label>
                        <input class="input" id="vMaxUses" type="number" min="1" step="1" placeholder="" />
                      </div>

                      <div>
                        <label>Expires At</label>
                        <input class="input" id="vExpiresAt" type="datetime-local" />
                        <div class="hint">Pilih tanggal & jam via kalender biar gampang.</div>
                      </div>
                      <div>
                        <label>Note</label>
                        <input class="input" id="vNote" placeholder="Catatan internal" />
                      </div>
                    </div>

                    <div class="btnRow">
                      <button class="btn btn--pri" id="btnUpsertVoucher" type="button">Save (Upsert)</button>
                      <button class="btn btn--bad" id="btnDisableVoucher" type="button">Disable</button>
                      <button class="btn btn--ghost" id="btnEnableVoucher" type="button">Enable</button>
                    </div>

                    <div class="hr"></div>

                    <h2 style="margin:0 0 8px; font-size:14px; font-weight:1000">Test (createqr)</h2>
                    <div class="row">
                      <div>
                        <label>Amount</label>
                        <input class="input" id="tAmount" type="number" min="1" step="1" value="10000" />
                      </div>
                      <div>
                        <label>Device ID</label>
                        <input class="input" id="tDeviceId" placeholder="dev_web_xxx" />
                      </div>
                      <div>
                        <label>Voucher Code (hidden)</label>
                        <input class="input" id="tVoucher" type="password" placeholder="(hidden)" autocomplete="off" />
                      </div>
                      <div>
                        <label>&nbsp;</label>
                        <button class="btn btn--ghost" id="btnGenDeviceId" type="button" style="width:100%">Generate Device ID</button>
                      </div>
                    </div>

                    <div class="btnRow">
                      <button class="btn btn--ok" id="btnTestCreateQR" type="button">Run Test</button>
                      <button class="btn btn--ghost" id="btnRevealTestVoucher" type="button">Reveal Voucher</button>
                    </div>

                    <div class="hint">
                      Device ID generate beda-beda itu normal. Voucher monthly tracking pakai deviceKey (hash).
                    </div>
                  </div>
                </div>
              </div>

            </div><!-- grid2 -->
          </div>
        </div>
      </section>

      <!-- Monthly -->
      <section class="section" id="tab-monthly">
        <div class="panel">
          <div class="panel__head">
            <div>
              <h2>Monthly Promo</h2>
              <div class="sub">1× per device per bulan + unlimited deviceKey</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn btn--ghost btn--mini" id="btnGetMonthly" type="button">Get</button>
              <button class="btn btn--pri btn--mini" id="btnSetMonthly" type="button">Save</button>
            </div>
          </div>

          <div class="panel__body">
            <div class="grid2">
              <div>
                <div class="row">
                  <div>
                    <label>Enabled</label>
                    <select class="input" id="mEnabled">
                      <option value="true">true</option>
                      <option value="false">false</option>
                    </select>
                  </div>
                  <div>
                    <label>Nama Promo</label>
                    <input class="input" id="mName" placeholder="PROMO BULANAN" />
                  </div>
                  <div>
                    <label>Diskon %</label>
                    <input class="input" id="mPercent" type="number" min="0" max="100" step="1" placeholder="5" />
                  </div>
                  <div>
                    <label>Max Rp</label>
                    <input class="input" id="mMaxRp" type="number" min="0" step="1" placeholder="2000" />
                  </div>
                </div>

                <div class="hr"></div>

                <h2 style="margin:0 0 8px; font-size:14px; font-weight:1000">Unlimited DeviceKey</h2>
                <div class="hint">
                  DeviceKey = <b>SHA-256(deviceId|pepper)</b> → hasil hex 64 char.<br/>
                  Itu <b>normal & aman</b> (hash), bukan token yang bisa ditebak.
                </div>

                <div class="row" style="margin-top:10px">
                  <div>
                    <label>Device ID</label>
                    <input class="input" id="uDeviceId" placeholder="dev_web_xxx" />
                  </div>
                  <div>
                    <label>Pepper</label>
                    <input class="input" id="uPepper" type="password" placeholder="(hidden)" autocomplete="off" />
                  </div>
                  <div>
                    <label>DeviceKey (hidden)</label>
                    <div class="inline">
                      <input class="input grow mono" id="uDeviceKey" type="password" placeholder="(hidden)" readonly />
                      <button class="btn btn--ghost btn--mini" id="btnRevealDeviceKey" type="button">Reveal</button>
                    </div>
                  </div>
                  <div>
                    <label>&nbsp;</label>
                    <button class="btn btn--ghost" id="btnGenDeviceKey" type="button" style="width:100%">Generate DeviceKey</button>
                  </div>
                </div>

                <div class="btnRow">
                  <button class="btn btn--ok" id="btnAddUnlimited" type="button">Add Unlimited</button>
                  <button class="btn btn--bad" id="btnRemoveUnlimited" type="button">Remove Unlimited</button>
                </div>
              </div>

              <div>
                <h2 style="margin:0 0 8px; font-size:14px; font-weight:1000">Monthly Snapshot (sanitized)</h2>
                <div class="codeBox" id="monthlyBox">{}</div>
                <div class="hint">Data di bawah sudah dimasking supaya gak bocor deviceKey.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Tools -->
      <section class="section" id="tab-tools">
        <div class="panel">
          <div class="panel__head">
            <div>
              <h2>Tools</h2>
              <div class="sub">Generate Device ID + catatan keamanan</div>
            </div>
          </div>
          <div class="panel__body">
            <div class="row">
              <div>
                <label>Generate Device ID</label>
                <input class="input mono" id="toolDeviceId" readonly />
                <div class="btnRow">
                  <button class="btn btn--pri" id="btnToolGenDeviceId" type="button">Generate</button>
                  <button class="btn btn--ghost" id="btnToolCopyDeviceId" type="button">Copy</button>
                </div>
                <div class="hint">
                  Generate beda-beda itu <b>normal</b> karena random. Device ID dipakai buat tracking promo bulanan.
                </div>
              </div>
              <div>
                <label>Catatan keamanan</label>
                <div class="codeBox">
- Kode voucher disembunyikan di UI.
- DeviceKey 64 char = SHA-256 hex (hash) → aman & standar.
- Admin Key cuma disimpan lokal (localStorage). Logout untuk hapus.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Debug (SANITIZED) -->
      <section class="section" id="tab-debug">
        <div class="panel">
          <div class="panel__head">
            <div>
              <h2>Debug (Sanitized)</h2>
              <div class="sub">Response terakhir sudah dimasking (kode voucher, url, deviceKey).</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn btn--ghost btn--mini" id="btnCopyLog" type="button">Copy</button>
              <button class="btn btn--ghost btn--mini" id="btnClearLog" type="button">Clear</button>
            </div>
          </div>
          <div class="panel__body">
            <div class="codeBox" id="logBox">{}</div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);

      const LS_KEY  = "levpay_admin_key";
      const LS_BASE = "levpay_admin_base";
      const LS_TAB  = "levpay_admin_tab";

      let ADMIN_KEY = "";
      let BASE = "";
      let voucherCache = [];
      let sortMode = "updated"; // updated | name

      const keyModal = $("keyModal");
      const baseUrlEl = $("baseUrl");
      const adminKeyEl = $("adminKey");

      const pillApi = $("pillApi");
      const pillKey = $("pillKey");
      const pillV = $("pillV");
      const pillM = $("pillM");
      const pillApiText = $("pillApiText");
      const pillKeyText = $("pillKeyText");
      const pillVText = $("pillVText");
      const pillMText = $("pillMText");

      const navBtns = Array.from(document.querySelectorAll(".navBtn"));
      const sections = Array.from(document.querySelectorAll(".section"));

      const btnUnlock = $("btnUnlock");
      const btnPing = $("btnPing");
      const btnFillDemo = $("btnFillDemo");
      const btnPingTop = $("btnPingTop");
      const btnRefreshAll = $("btnRefreshAll");
      const btnLogout = $("btnLogout");

      const btnLoadVouchers = $("btnLoadVouchers");
      const btnNewVoucher = $("btnNewVoucher");
      const qSearch = $("qSearch");
      const qFilter = $("qFilter");
      const btnSortName = $("btnSortName");
      const btnSortUpdated = $("btnSortUpdated");
      const voucherTbody = $("voucherTbody");

      const editBadge = $("editBadge");
      const vCode = $("vCode");
      const vEnabled = $("vEnabled");
      const vName = $("vName");
      const vPercent = $("vPercent");
      const vMaxRp = $("vMaxRp");
      const vMaxUses = $("vMaxUses");
      const vExpiresAt = $("vExpiresAt");
      const vNote = $("vNote");
      const btnRevealCode = $("btnRevealCode");

      const btnUpsertVoucher = $("btnUpsertVoucher");
      const btnDisableVoucher = $("btnDisableVoucher");
      const btnEnableVoucher = $("btnEnableVoucher");

      const tAmount = $("tAmount");
      const tDeviceId = $("tDeviceId");
      const tVoucher = $("tVoucher");
      const btnGenDeviceId = $("btnGenDeviceId");
      const btnTestCreateQR = $("btnTestCreateQR");
      const btnRevealTestVoucher = $("btnRevealTestVoucher");

      const btnGetMonthly = $("btnGetMonthly");
      const btnSetMonthly = $("btnSetMonthly");
      const mEnabled = $("mEnabled");
      const mName = $("mName");
      const mPercent = $("mPercent");
      const mMaxRp = $("mMaxRp");
      const monthlyBox = $("monthlyBox");

      const uDeviceId = $("uDeviceId");
      const uPepper = $("uPepper");
      const uDeviceKey = $("uDeviceKey");
      const btnGenDeviceKey = $("btnGenDeviceKey");
      const btnAddUnlimited = $("btnAddUnlimited");
      const btnRemoveUnlimited = $("btnRemoveUnlimited");
      const btnRevealDeviceKey = $("btnRevealDeviceKey");

      const toolDeviceId = $("toolDeviceId");
      const btnToolGenDeviceId = $("btnToolGenDeviceId");
      const btnToolCopyDeviceId = $("btnToolCopyDeviceId");

      const logBox = $("logBox");
      const btnCopyLog = $("btnCopyLog");
      const btnClearLog = $("btnClearLog");

      // ===== UI helpers =====
      function toast(msg){
        const el = $("toast");
        el.textContent = msg;
        el.classList.add("is-on");
        clearTimeout(el._t);
        el._t = setTimeout(()=>el.classList.remove("is-on"), 1600);
      }
      function setPill(el, tone, text){
        el.dataset.tone = tone;
        el.querySelector("span:last-child").textContent = text;
      }
      function lockUI(locked){
        document.body.classList.toggle("is-locked", !!locked);
        keyModal.classList.toggle("is-on", !!locked);
        keyModal.setAttribute("aria-hidden", locked ? "false" : "true");
      }

      function apiBase(){
        return String(BASE||"").trim().replace(/\/+$/,"");
      }
      function endpoint(action){
        // endpoint tidak ditampilkan di UI, cuma dipakai internal
        return apiBase() + "/api/orkut?action=" + encodeURIComponent(action);
      }

      async function jfetch(url, opts){
        const r = await fetch(url, opts);
        const text = await r.text();
        let json = null;
        try { json = text ? JSON.parse(text) : {}; } catch { json = { raw: text }; }
        return { ok: r.ok, status: r.status, json };
      }

      async function callAction(action, { method="GET", admin=false, body=null } = {}){
        const url = endpoint(action);
        const headers = {};
        if (method !== "GET") headers["Content-Type"] = "application/json";
        if (admin) headers["X-Admin-Key"] = ADMIN_KEY;

        const res = await jfetch(url, {
          method,
          headers,
          body: body ? JSON.stringify(body) : undefined
        });
        return { action, ok: res.ok, status: res.status, json: res.json };
      }

      async function callAny(actions, cfg){
        let last=null;
        for (const a of actions){
          const r = await callAction(a, cfg);
          last=r;
          if (r.ok) return r;
          if (r.status === 401) return r;
        }
        return last;
      }

      // ===== Sanitizer (hide codes, urls, deviceKeys) =====
      function maskMid(s){
        const str = String(s||"");
        if (str.length <= 6) return "••••••";
        return "••••" + str.slice(-2);
      }
      function deepSanitize(obj){
        // clone + sanitize strings/keys
        const seen = new WeakSet();
        const walk = (x, k)=>{
          if (x == null) return x;
          if (typeof x === "string"){
            const s = x;
            // hide urls / endpoints
            if (s.includes("/api/")) return "••••(hidden-url)••••";
            // hide deviceKey length 64 hex-ish
            if (/^[a-f0-9]{64}$/i.test(s)) return "••••(hidden-deviceKey)••••";
            // hide voucher codes commonly short uppercase
            if (k && String(k).toLowerCase().includes("code")) return "••••(hidden-code)••••";
            if (k && String(k).toLowerCase().includes("voucher")) return "••••(hidden-voucher)••••";
            return s;
          }
          if (typeof x !== "object") return x;
          if (seen.has(x)) return "[circular]";
          seen.add(x);

          if (Array.isArray(x)){
            return x.map(v=>walk(v, k));
          }

          const out = {};
          for (const [kk,vv] of Object.entries(x)){
            const low = String(kk).toLowerCase();
            if (low.includes("devicekey")) out[kk] = "••••(hidden-deviceKey)••••";
            else if (low === "code") out[kk] = "••••(hidden-code)••••";
            else if (low.includes("voucher")) out[kk] = "••••(hidden-voucher)••••";
            else if (low.includes("url") || low.includes("path")) out[kk] = "••••(hidden-url)••••";
            else out[kk] = walk(vv, kk);
          }
          return out;
        };
        return walk(obj, "");
      }

      function log(obj){
        try{
          logBox.textContent = JSON.stringify(deepSanitize(obj), null, 2);
        }catch{
          logBox.textContent = "{ }";
        }
      }

      function sanitizeCode(s){
        return String(s||"").trim().toUpperCase().replace(/\s+/g,"");
      }

      function toIsoFromDatetimeLocal(v){
        const s = String(v||"").trim();
        if (!s) return null;
        const d = new Date(s);
        if (!Number.isFinite(d.getTime())) return null;
        return d.toISOString();
      }
      function fromIsoToDatetimeLocal(iso){
        if (!iso) return "";
        const d = new Date(iso);
        if (!Number.isFinite(d.getTime())) return "";
        const pad = (n)=>String(n).padStart(2,"0");
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      }
      function maybeNumber(v){
        const s = String(v ?? "").trim();
        if (s === "") return undefined;
        const n = Number(s);
        return Number.isFinite(n) ? n : undefined;
      }

      function setEditBadge(mode){
        // mode: "idle"|"on"|"off"
        if (mode === "on"){
          editBadge.dataset.tone = "ok";
          editBadge.innerHTML = '<span class="dot"></span><span>Loaded (ON)</span>';
        } else if (mode === "off"){
          editBadge.dataset.tone = "bad";
          editBadge.innerHTML = '<span class="dot"></span><span>Loaded (OFF)</span>';
        } else {
          editBadge.dataset.tone = "warn";
          editBadge.innerHTML = '<span class="dot"></span><span>Idle</span>';
        }
      }

      function genDeviceId(){
        const rnd = Math.random().toString(36).slice(2, 8);
        const rnd2 = Math.random().toString(36).slice(2, 8);
        return "dev_web_" + rnd + "_" + rnd2;
      }

      async function sha256Hex(str){
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        const arr = Array.from(new Uint8Array(buf));
        return arr.map(b => b.toString(16).padStart(2,"0")).join("");
      }

      function copy(text){
        return navigator.clipboard.writeText(String(text||""))
          .then(()=>toast("Copied ✅"))
          .catch(()=>toast("Copy gagal"));
      }

      // ===== API ops =====
      async function ping(){
        const res = await callAction("ping", { method:"GET", admin:false });
        log({ type:"ping", ...res });
        if (res.ok){
          setPill(pillApi, "ok", "API: OK");
          toast("Ping OK");
        } else {
          setPill(pillApi, "bad", "API: ERROR");
          toast("Ping ERROR ("+res.status+")");
        }
        return res;
      }

      async function adminValidateKey(){
        // validate with admin endpoint (try disable voucher with dummy code)
        const candidates = ["admin_disable_voucher","voucher.disable","admin_voucher_disable"];
        const res = await callAny(candidates, {
          method:"POST",
          admin:true,
          body:{ code:"__VALIDATE__" }
        });

        log({ type:"validate", status: res?.status, ok: res?.ok });

        if (res?.status === 401){
          setPill(pillKey, "bad", "Key: salah");
          return false;
        }
        setPill(pillKey, "ok", "Key: OK");
        return true;
      }

      async function loadVouchers(){
        setPill(pillV, "warn", "Voucher: loading...");
        const candidates = ["admin_list_voucher","voucher.list","admin_voucher_list"];
        const res = await callAny(candidates, { method:"GET", admin:true });

        log({ type:"voucher.list", status: res?.status, ok: res?.ok, json: res?.json });

        if (res.status === 401){
          setPill(pillV, "bad", "Voucher: unauthorized");
          toast("Unauthorized (key salah)");
          return;
        }
        if (!res.ok){
          setPill(pillV, "bad", "Voucher: error");
          toast("Gagal load voucher ("+res.status+")");
          return;
        }

        const data = res.json?.data ?? res.json ?? [];
        const items = Array.isArray(data) ? data : (Array.isArray(data?.items) ? data.items : []);

        voucherCache = items.map(v=>({
          code: sanitizeCode(v.code || v.kode || ""),
          name: String(v.name ?? v.nama ?? "").trim(),
          enabled: v.enabled !== false,
          percent: Number(v.percent ?? 0),
          maxRp: Number(v.maxRp ?? 0),
          uses: Number(v.uses ?? 0),
          maxUses: v.maxUses ?? null,
          expiresAt: v.expiresAt ?? null,
          updatedAt: v.updatedAt ?? null,
          note: v.note ?? null
        })).filter(v=>v.code);

        const onCount = voucherCache.filter(v=>v.enabled).length;
        setPill(pillV, "ok", `Voucher: ${onCount} ON / ${voucherCache.length} total`);
        renderVouchers();
        toast("Voucher loaded ✅");
      }

      function sortVouchers(arr){
        const a = [...arr];
        if (sortMode === "name"){
          a.sort((x,y)=>String(x.name||"").localeCompare(String(y.name||"")));
        } else {
          a.sort((x,y)=>String(y.updatedAt||"").localeCompare(String(x.updatedAt||"")));
        }
        return a;
      }

      function applyFilter(arr){
        const s = String(qSearch.value||"").trim().toLowerCase();
        const f = String(qFilter.value||"on");
        return arr.filter(v=>{
          if (f === "on" && !v.enabled) return false;
          if (f === "off" && v.enabled) return false;
          if (s){
            const hay = ((v.name||"") + " " + (v.note||"")).toLowerCase();
            if (!hay.includes(s)) return false;
          }
          return true;
        });
      }

      function escapeHtml(s){
        return String(s ?? "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function renderVouchers(){
        const filtered = sortVouchers(applyFilter(voucherCache));
        if (!filtered.length){
          voucherTbody.innerHTML = `<tr><td colspan="6" class="mut">Tidak ada hasil.</td></tr>`;
          return;
        }

        voucherTbody.innerHTML = filtered.map(v=>{
          const tone = v.enabled ? "ok" : "bad";
          const exp = v.expiresAt ? new Date(v.expiresAt).toLocaleString("id-ID") : "—";
          const displayName = v.name ? escapeHtml(v.name) : '<span class="mut2">(no name)</span>';
          const cap = v.maxRp ? v.maxRp.toLocaleString("id-ID") : "∞";
          const uses = Number.isFinite(v.uses) ? v.uses : 0;
          const maxUses = (v.maxUses != null ? v.maxUses : "∞");

          return `
            <tr data-code="${escapeHtml(v.code)}">
              <td>
                <span class="badge" data-tone="${tone}">
                  <span class="dot"></span>
                  <span>${v.enabled ? "ON" : "OFF"}</span>
                </span>
              </td>
              <td>
                <div style="font-weight:1000">${displayName}</div>
                <div class="mut2" style="margin-top:2px">ID: ${escapeHtml(maskMid(v.code))}</div>
              </td>
              <td class="right mono">${escapeHtml(String(v.percent||0))}</td>
              <td class="right mono">${escapeHtml(String(cap))}</td>
              <td class="right mono">${escapeHtml(String(uses))}<span class="mut2">/${escapeHtml(String(maxUses))}</span></td>
              <td class="mono">${escapeHtml(exp)}</td>
            </tr>
          `;
        }).join("");

        Array.from(voucherTbody.querySelectorAll("tr[data-code]")).forEach(tr=>{
          tr.addEventListener("click", ()=>{
            const code = tr.getAttribute("data-code");
            const v = voucherCache.find(x=>x.code === code);
            if (!v) return;
            loadVoucherToForm(v);
            toast("Voucher loaded");
          });
        });
      }

      function loadVoucherToForm(v){
        vCode.value = v.code || "";
        vEnabled.value = String(!!v.enabled);
        vName.value = v.name || "";
        vPercent.value = String(Number(v.percent||0));
        vMaxRp.value = String(Number(v.maxRp||0));
        vMaxUses.value = (v.maxUses == null ? "" : String(v.maxUses));
        vExpiresAt.value = fromIsoToDatetimeLocal(v.expiresAt);
        vNote.value = v.note || "";

        tVoucher.value = v.code || "";

        setEditBadge(v.enabled ? "on" : "off");
      }

      function clearVoucherForm(){
        vCode.value = "";
        vEnabled.value = "true";
        vName.value = "";
        vPercent.value = "";
        vMaxRp.value = "0";
        vMaxUses.value = "";
        vExpiresAt.value = "";
        vNote.value = "";
        tVoucher.value = "";
        setEditBadge("idle");
      }

      function buildVoucherPayload(forceEnabled /* true|false|undefined */){
        const code = sanitizeCode(vCode.value);
        const percent = maybeNumber(vPercent.value);
        if (!code) throw new Error("code wajib");
        if (percent == null) throw new Error("percent wajib");

        const payload = { code, percent };
        payload.enabled = (forceEnabled != null) ? !!forceEnabled : (String(vEnabled.value) === "true");

        const name = String(vName.value||"").trim();
        const note = String(vNote.value||"").trim();
        const maxRp = maybeNumber(vMaxRp.value);
        const maxUses = maybeNumber(vMaxUses.value);
        const expiresAt = toIsoFromDatetimeLocal(vExpiresAt.value);

        if (name) payload.name = name;
        if (note) payload.note = note;
        if (maxRp != null) payload.maxRp = maxRp;
        if (maxUses != null) payload.maxUses = maxUses; // empty = omit (unlimited)
        if (expiresAt) payload.expiresAt = expiresAt;

        return payload;
      }

      async function upsertVoucher(forceEnabled){
        const payload = buildVoucherPayload(forceEnabled);
        const candidates = ["admin_upsert_voucher","voucher.upsert","admin_voucher_upsert"];
        const res = await callAny(candidates, { method:"POST", admin:true, body: payload });

        log({ type:"voucher.upsert", status: res?.status, ok: res?.ok, payload, json: res?.json });

        if (res.status === 401){ toast("Unauthorized"); return; }
        if (!res.ok){ toast("Upsert gagal ("+res.status+")"); return; }

        toast("Saved ✅");
        await loadVouchers();
        setEditBadge(payload.enabled ? "on" : "off");
      }

      async function disableVoucher(){
        const code = sanitizeCode(vCode.value);
        if (!code){ toast("Kode kosong"); return; }
        if (!confirm("Disable voucher ini?")) return;

        const candidates = ["admin_disable_voucher","voucher.disable","admin_voucher_disable"];
        const res = await callAny(candidates, { method:"POST", admin:true, body:{ code } });

        log({ type:"voucher.disable", status: res?.status, ok: res?.ok, json: res?.json });

        if (res.status === 401){ toast("Unauthorized"); return; }
        if (!res.ok){ toast("Disable gagal ("+res.status+")"); return; }

        toast("Disabled ✅");
        vEnabled.value = "false";
        setEditBadge("off");
        await loadVouchers();
      }

      async function enableVoucher(){
        await upsertVoucher(true);
      }

      async function getMonthly(){
        setPill(pillM, "warn", "Monthly: loading...");
        const candidates = ["monthly.get","admin_get_monthly_promo","monthly_get"];
        const res = await callAny(candidates, { method:"GET", admin:true });

        log({ type:"monthly.get", status: res?.status, ok: res?.ok, json: res?.json });

        if (res.status === 401){
          setPill(pillM, "bad", "Monthly: unauthorized");
          toast("Unauthorized");
          return;
        }
        if (!res.ok){
          setPill(pillM, "bad", "Monthly: error");
          toast("Get monthly gagal ("+res.status+")");
          return;
        }

        const data = res.json?.data ?? res.json ?? {};
        // fill inputs
        if (data.enabled != null) mEnabled.value = String(!!data.enabled);
        if (data.name != null) mName.value = String(data.name);
        if (data.percent != null) mPercent.value = String(data.percent);
        if (data.maxRp != null) mMaxRp.value = String(data.maxRp);

        monthlyBox.textContent = JSON.stringify(deepSanitize(data), null, 2);
        setPill(pillM, "ok", "Monthly: OK");
        toast("Monthly loaded ✅");
      }

      function buildMonthlyPayload(extra){
        const payload = {};
        payload.enabled = (String(mEnabled.value) === "true");
        const name = String(mName.value||"").trim();
        const percent = maybeNumber(mPercent.value);
        const maxRp = maybeNumber(mMaxRp.value);

        if (name) payload.name = name;
        if (percent != null) payload.percent = percent;
        if (maxRp != null) payload.maxRp = maxRp;

        return { ...payload, ...(extra||{}) };
      }

      async function setMonthly(extra){
        const payload = buildMonthlyPayload(extra);
        const candidates = ["admin_set_monthly_promo","monthly.set","monthly_set"];
        const res = await callAny(candidates, { method:"POST", admin:true, body: payload });

        log({ type:"monthly.set", status: res?.status, ok: res?.ok, json: res?.json });

        if (res.status === 401){ toast("Unauthorized"); return; }
        if (!res.ok){ toast("Save monthly gagal ("+res.status+")"); return; }

        toast("Monthly saved ✅");
        await getMonthly();
      }

      async function genDeviceKey(){
        const did = String(uDeviceId.value||"").trim();
        const pep = String(uPepper.value||"").trim();
        if (!did || !pep){ toast("Isi deviceId & pepper"); return; }
        const key = await sha256Hex(did + "|" + pep);
        uDeviceKey.value = key; // disembunyikan (password)
        toast("DeviceKey generated");
      }

      async function addUnlimited(){
        const dk = String(uDeviceKey.value||"").trim();
        if (!dk){ toast("Generate deviceKey dulu"); return; }
        await setMonthly({ addUnlimitedDeviceKey: dk });
      }
      async function removeUnlimited(){
        const dk = String(uDeviceKey.value||"").trim();
        if (!dk){ toast("Generate deviceKey dulu"); return; }
        await setMonthly({ removeUnlimitedDeviceKey: dk });
      }

      async function testCreateQR(){
        const amount = Number(String(tAmount.value||"").trim());
        const deviceId = String(tDeviceId.value||"").trim();
        const voucher = String(tVoucher.value||"").trim();

        if (!Number.isFinite(amount) || amount < 1){ toast("Amount invalid"); return; }
        if (!deviceId){ toast("Device ID wajib"); return; }

        const res = await callAction("createqr", { method:"POST", admin:false, body:{ amount, deviceId, voucher } });
        log({ type:"createqr", status: res?.status, ok: res?.ok, json: res?.json });

        if (!res.ok){ toast("Test gagal ("+res.status+")"); return; }

        const d = res.json?.data ?? res.json ?? {};
        const pricing = d?.pricing || null;
        const disc = pricing?.discountRp ?? 0;
        toast("OK • discountRp: " + disc);
      }

      // ===== Tabs =====
      function setTab(id){
        navBtns.forEach(b=>b.classList.toggle("is-active", b.getAttribute("data-tab") === id));
        sections.forEach(s=>s.classList.toggle("is-on", s.id === id));
        localStorage.setItem(LS_TAB, id);
      }
      navBtns.forEach(btn=>btn.addEventListener("click", ()=>setTab(btn.getAttribute("data-tab"))));

      // ===== Unlock / Logout =====
      async function doUnlock(){
        BASE = String(baseUrlEl.value||"").trim();
        localStorage.setItem(LS_BASE, BASE);

        const rawKey = String(adminKeyEl.value||"").trim();
        if (rawKey && rawKey !== "••••••••••") ADMIN_KEY = rawKey;
        if (!ADMIN_KEY){ toast("Admin key wajib"); return; }

        localStorage.setItem(LS_KEY, ADMIN_KEY);

        await ping();
        const ok = await adminValidateKey();
        if (!ok){ toast("Admin key salah (401)"); return; }

        lockUI(false);
        toast("Masuk ✅");

        await loadVouchers();
        await getMonthly();
      }

      function doLogout(){
        ADMIN_KEY = "";
        localStorage.removeItem(LS_KEY);
        setPill(pillKey, "warn", "Key: belum");
        lockUI(true);
      }

      // ===== Events =====
      btnUnlock.addEventListener("click", doUnlock);
      btnPing.addEventListener("click", ping);
      btnPingTop.addEventListener("click", ping);

      btnFillDemo.addEventListener("click", ()=>{
        baseUrlEl.value = "";
        adminKeyEl.value = "CONTOH_KEY";
        toast("Contoh diisi (bukan key asli)");
      });

      btnLogout.addEventListener("click", ()=>{
        if (confirm("Logout?")) doLogout();
      });

      btnRefreshAll.addEventListener("click", async ()=>{
        await ping();
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        await loadVouchers();
        await getMonthly();
      });

      btnNewVoucher.addEventListener("click", ()=>{
        clearVoucherForm();
        toast("New voucher");
      });

      btnLoadVouchers.addEventListener("click", async ()=>{
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        await loadVouchers();
      });

      qSearch.addEventListener("input", renderVouchers);
      qFilter.addEventListener("change", renderVouchers);

      btnSortName.addEventListener("click", ()=>{
        sortMode = "name";
        toast("Sort: NAME");
        renderVouchers();
      });
      btnSortUpdated.addEventListener("click", ()=>{
        sortMode = "updated";
        toast("Sort: UPDATED");
        renderVouchers();
      });

      btnUpsertVoucher.addEventListener("click", async ()=>{
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        try{ await upsertVoucher(); } catch(e){ toast(e?.message || "error"); }
      });

      btnDisableVoucher.addEventListener("click", async ()=>{
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        await disableVoucher();
      });

      btnEnableVoucher.addEventListener("click", async ()=>{
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        try{ await enableVoucher(); } catch(e){ toast(e?.message || "error"); }
      });

      btnGenDeviceId.addEventListener("click", ()=>{
        const id = genDeviceId();
        tDeviceId.value = id;
        uDeviceId.value = id;
        toolDeviceId.value = id;
        toast("Device ID dibuat");
      });

      btnTestCreateQR.addEventListener("click", testCreateQR);

      btnRevealCode.addEventListener("click", ()=>{
        const isPwd = vCode.type === "password";
        vCode.type = isPwd ? "text" : "password";
        btnRevealCode.textContent = isPwd ? "Hide" : "Reveal";
      });

      btnRevealTestVoucher.addEventListener("click", ()=>{
        const isPwd = tVoucher.type === "password";
        tVoucher.type = isPwd ? "text" : "password";
        btnRevealTestVoucher.textContent = isPwd ? "Hide Voucher" : "Reveal Voucher";
      });

      btnGetMonthly.addEventListener("click", async ()=>{
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        await getMonthly();
      });

      btnSetMonthly.addEventListener("click", async ()=>{
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        await setMonthly();
      });

      btnGenDeviceKey.addEventListener("click", genDeviceKey);
      btnAddUnlimited.addEventListener("click", async ()=>{
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        await addUnlimited();
      });
      btnRemoveUnlimited.addEventListener("click", async ()=>{
        const ok = await adminValidateKey();
        if (!ok){ toast("Key salah / belum"); return; }
        await removeUnlimited();
      });

      btnRevealDeviceKey.addEventListener("click", ()=>{
        const isPwd = uDeviceKey.type === "password";
        uDeviceKey.type = isPwd ? "text" : "password";
        btnRevealDeviceKey.textContent = isPwd ? "Hide" : "Reveal";
      });

      btnToolGenDeviceId.addEventListener("click", ()=>{
        toolDeviceId.value = genDeviceId();
        toast("Generated");
      });
      btnToolCopyDeviceId.addEventListener("click", ()=>copy(toolDeviceId.value));

      btnCopyLog.addEventListener("click", ()=>copy(logBox.textContent));
      btnClearLog.addEventListener("click", ()=>{ logBox.textContent="{}"; toast("Cleared"); });

      // ===== Init =====
      function loadSaved(){
        BASE = localStorage.getItem(LS_BASE) || "";
        ADMIN_KEY = localStorage.getItem(LS_KEY) || "";

        baseUrlEl.value = BASE;
        adminKeyEl.value = ADMIN_KEY ? "••••••••••" : "";

        const savedTab = localStorage.getItem(LS_TAB) || "tab-voucher";
        setTab(savedTab);

        const did = genDeviceId();
        tDeviceId.value = did;
        uDeviceId.value = did;
        toolDeviceId.value = did;

        setPill(pillV, "warn", "Voucher: —");
        setPill(pillM, "warn", "Monthly: —");

        if (ADMIN_KEY){
          lockUI(false);
          setPill(pillKey, "warn", "Key: tersimpan");
          setTimeout(async ()=>{
            await ping();
            const ok = await adminValidateKey();
            if (!ok){
              toast("Admin key salah. Login ulang.");
              doLogout();
              return;
            }
            toast("Session OK ✅");
            await loadVouchers();
            await getMonthly();
          }, 80);
        } else {
          lockUI(true);
          setPill(pillKey, "warn", "Key: belum");
        }
      }

      loadSaved();
    })();
  </script>
</body>
</html>