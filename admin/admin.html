<!-- admin/admin.html  (LEVPay Admin Panel - single file) -->
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LevPay Admin</title>
  <style>
    :root{
      --bg:#0b0f18; --card:#0f1626; --card2:#0c1322;
      --text:#eaf0ff; --muted:#9aa6c2; --muted2:#7f8aa6;
      --line:rgba(255,255,255,.10);
      --good:#22c55e; --warn:#f97316; --bad:#ef4444; --brand1:#7c3aed; --brand2:#22d3ee;
      --r:18px;
      --shadow:0 18px 48px rgba(0,0,0,.35);
      font-synthesis-weight:none;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(124,58,237,.35), transparent 60%),
                  radial-gradient(1200px 700px at 90% 0%, rgba(34,211,238,.22), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    a{ color:inherit; }
    .wrap{ max-width:1100px; margin:0 auto; padding:22px 14px 60px; }
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin-bottom:16px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:16px;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(34,211,238,1));
      box-shadow:0 16px 40px rgba(34,211,238,.12);
    }
    h1{ margin:0; font-size:18px; font-weight:950; letter-spacing:-.02em; }
    .sub{ color:var(--muted); font-size:12px; font-weight:800; margin-top:2px; }

    .card{
      border-radius:var(--r);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-bottom:14px;
    }
    .cardHead{
      padding:14px 14px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .cardTitle{ font-size:14px; font-weight:1000; letter-spacing:-.01em; margin:0; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight:950; font-size:12px;
      color:var(--text);
      user-select:none;
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:rgba(255,255,255,.35); }
    .dot.good{ background: rgba(34,197,94,.95); }
    .dot.warn{ background: rgba(249,115,22,.95); }
    .dot.bad{ background: rgba(239,68,68,.95); }
    .cardBody{ padding:14px; }

    .grid{ display:grid; gap:12px; }
    @media(min-width: 980px){
      .grid2{ grid-template-columns: 1.1fr .9fr; }
      .grid3{ grid-template-columns: 1fr 1fr 1fr; }
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .field{ display:grid; gap:8px; }
    .label{ color:var(--muted); font-weight:950; font-size:12px; }
    .input, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      font-weight:850;
      font-size:13px;
    }
    textarea{ min-height:110px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight:700; }

    .btn{
      border:none;
      border-radius:14px;
      padding:12px 12px;
      font-weight:950;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:10px;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
      touch-action: manipulation;
      transition: transform .12s ease, opacity .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
    .btnPrimary{
      color:#08101f;
      background: linear-gradient(90deg, rgba(124,58,237,1), rgba(34,211,238,1));
      box-shadow:0 16px 40px rgba(34,211,238,.14);
    }
    .btnGhost{
      color:var(--text);
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
    }
    .btnBad{
      color: rgba(255,230,230,.96);
      background: rgba(239,68,68,.14);
      border:1px solid rgba(239,68,68,.28);
    }
    .btnWarn{
      color: rgba(255,244,232,.96);
      background: rgba(249,115,22,.14);
      border:1px solid rgba(249,115,22,.28);
    }

    .tabs{
      display:flex; flex-wrap:wrap; gap:8px;
      margin: 0 0 12px;
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      font-weight:950;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .tab.isActive{
      border-color: rgba(34,211,238,.38);
      background: rgba(34,211,238,.10);
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.12);
    }
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:12px;
      vertical-align:top;
    }
    .table th{
      text-align:left;
      color:var(--muted);
      font-weight:1000;
      background: rgba(255,255,255,.03);
    }
    .table tr:last-child td{ border-bottom:none; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color:var(--muted); }
    .muted2{ color:var(--muted2); }
    .help{
      color:var(--muted);
      font-size:12px;
      line-height:1.55;
      font-weight:800;
      margin-top:8px;
      white-space:pre-line;
    }
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      width:min(560px, 92vw);
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,13,22,.92);
      box-shadow: var(--shadow);
      padding:12px 12px;
      display:none;
      z-index:999;
    }
    .toast.isOn{ display:block; }
    .toast b{ font-weight:1000; }
    .kbd{
      font-family: ui-monospace, monospace;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
    }

    /* simple login overlay */
    .overlay{
      position:fixed; inset:0; z-index:1000;
      display:none; place-items:center;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .overlay.isOn{ display:grid; }
    .panel{
      width:min(560px, 92vw);
      border-radius: 22px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(10,13,22,.94);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panelHead{
      padding:14px 14px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between;
    }
    .panelBody{ padding:14px; }
  </style>
</head>

<body>
  <div class="overlay" id="loginOverlay" aria-hidden="true">
    <div class="panel">
      <div class="panelHead">
        <div style="display:flex;align-items:center;gap:10px">
          <div class="logo" style="width:36px;height:36px;border-radius:14px"></div>
          <div>
            <div style="font-weight:1000">Login Admin</div>
            <div class="muted" style="font-size:12px;font-weight:800">Buat akses endpoint ADMIN (voucher/monthly/tx)</div>
          </div>
        </div>
        <button class="btn btnGhost" id="btnCloseLogin" type="button">✕</button>
      </div>
      <div class="panelBody grid" style="gap:12px">
        <div class="field">
          <div class="label">Base URL (optional)</div>
          <input class="input" id="loginHost" placeholder="kosong = pakai origin sekarang" />
          <div class="help">Contoh: https://levpay-api.vercel.app</div>
        </div>
        <div class="field">
          <div class="label">Admin Key (header: <span class="kbd">X-Admin-Key</span>)</div>
          <input class="input" id="loginKey" placeholder="mis: LEVIN6824" />
        </div>
        <div class="row">
          <button class="btn btnPrimary" id="btnLogin" type="button" style="flex:1">Masuk</button>
          <button class="btn btnGhost" id="btnLoginClear" type="button">Reset</button>
        </div>
        <div class="help">
          Catatan:
          - Page ini akan call: <span class="kbd">/api/levpay?action=...</span>
          - Semua action admin butuh header <span class="kbd">X-Admin-Key</span> yang benar.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>LevPay Admin Panel</h1>
          <div class="sub">
            Endpoint: <span class="kbd">/api/levpay</span> • Router actions: voucher.*, monthly.*, tx.*, discount.*
          </div>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button class="btn btnGhost" id="btnOpenLogin" type="button">Login / Settings</button>
        <button class="btn btnGhost" id="btnPing" type="button">Ping</button>
        <button class="btn btnPrimary" id="btnReloadAll" type="button">Reload</button>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div>
          <div class="cardTitle">Connection</div>
          <div class="muted" style="font-size:12px;font-weight:800;margin-top:4px">
            Base: <span class="mono" id="connBase">—</span> • Admin: <span class="mono" id="connAdmin">—</span>
          </div>
        </div>
        <div class="pill" id="connStatus">
          <span class="dot" id="connDot"></span>
          <span id="connText">Not checked</span>
        </div>
      </div>
      <div class="cardBody">
        <div class="tabs" id="tabs">
          <div class="tab isActive" data-tab="vouchers">Vouchers</div>
          <div class="tab" data-tab="monthly">Monthly Promo</div>
          <div class="tab" data-tab="tx">TX Store</div>
          <div class="tab" data-tab="discount">Discount Test</div>
          <div class="tab" data-tab="raw">Raw / Debug</div>
        </div>

        <!-- VOUCHERS -->
        <section id="tab-vouchers">
          <div class="grid grid2">
            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">Voucher List</div>
                <div class="row">
                  <button class="btn btnGhost" id="btnVoucherList" type="button">List</button>
                </div>
              </div>
              <div class="cardBody">
                <table class="table" id="voucherTable">
                  <thead>
                    <tr>
                      <th style="width:150px">Code</th>
                      <th>Name</th>
                      <th style="width:90px">%</th>
                      <th style="width:120px">MaxRp</th>
                      <th style="width:120px">MaxUses</th>
                      <th style="width:80px">Uses</th>
                      <th style="width:120px">Enabled</th>
                      <th style="width:160px">Actions</th>
                    </tr>
                  </thead>
                  <tbody id="voucherTbody">
                    <tr><td colspan="8" class="muted">Klik “List” buat load voucher.</td></tr>
                  </tbody>
                </table>
                <div class="help">
                  Tips:
                  - Disable voucher = action <span class="kbd">voucher.disable</span> (ADMIN).
                  - Upsert voucher = action <span class="kbd">voucher.upsert</span> (ADMIN).
                </div>
              </div>
            </div>

            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">Upsert / Disable Voucher</div>
                <div class="row">
                  <button class="btn btnGhost" id="btnVoucherGet" type="button">Get</button>
                  <button class="btn btnPrimary" id="btnVoucherUpsert" type="button">Upsert</button>
                  <button class="btn btnBad" id="btnVoucherDisable" type="button">Disable</button>
                </div>
              </div>
              <div class="cardBody grid" style="gap:12px">
                <div class="field">
                  <div class="label">Code</div>
                  <input class="input" id="vCode" placeholder="KINGLEV" />
                </div>
                <div class="field">
                  <div class="label">Name</div>
                  <input class="input" id="vName" placeholder="Voucher 60%" />
                </div>

                <div class="row">
                  <div class="field" style="flex:1;min-width:160px">
                    <div class="label">Percent (0-100)</div>
                    <input class="input" id="vPercent" type="number" placeholder="60" />
                  </div>
                  <div class="field" style="flex:1;min-width:160px">
                    <div class="label">MaxRp (0 = no cap)</div>
                    <input class="input" id="vMaxRp" type="number" placeholder="0" />
                  </div>
                </div>

                <div class="row">
                  <div class="field" style="flex:1;min-width:160px">
                    <div class="label">MaxUses (blank = unlimited)</div>
                    <input class="input" id="vMaxUses" type="number" placeholder="100" />
                  </div>
                  <div class="field" style="flex:1;min-width:160px">
                    <div class="label">ExpiresAt (ISO, optional)</div>
                    <input class="input" id="vExpiresAt" placeholder="2026-01-01T00:00:00.000Z" />
                  </div>
                </div>

                <div class="field">
                  <div class="label">Note (optional)</div>
                  <input class="input" id="vNote" placeholder="Catatan internal" />
                </div>

                <div class="row" style="align-items:center">
                  <label class="pill" style="cursor:pointer">
                    <input type="checkbox" id="vEnabled" style="accent-color: #22d3ee" checked />
                    Enabled
                  </label>
                  <div class="muted" style="font-size:12px;font-weight:800">
                    Upsert akan otomatis uppercase code.
                  </div>
                </div>

                <div class="help">
                  Contoh voucher 60%:
                  - Code: <span class="kbd">KINGLEV</span>
                  - Percent: <span class="kbd">60</span>
                  - MaxRp: <span class="kbd">0</span> (biar 60% full)
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- MONTHLY -->
        <section id="tab-monthly" style="display:none">
          <div class="grid grid2">
            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">Monthly Promo</div>
                <div class="row">
                  <button class="btn btnGhost" id="btnMonthlyGet" type="button">Get</button>
                  <button class="btn btnPrimary" id="btnMonthlySet" type="button">Set</button>
                </div>
              </div>
              <div class="cardBody grid" style="gap:12px">
                <div class="row" style="align-items:center">
                  <label class="pill" style="cursor:pointer">
                    <input type="checkbox" id="mEnabled" style="accent-color:#22d3ee" checked />
                    Enabled
                  </label>
                  <div class="muted" style="font-size:12px;font-weight:800">Action: <span class="kbd">monthly.get</span> / <span class="kbd">monthly.set</span> (ADMIN)</div>
                </div>

                <div class="field">
                  <div class="label">Name</div>
                  <input class="input" id="mName" placeholder="PROMO BULANAN" />
                </div>

                <div class="row">
                  <div class="field" style="flex:1;min-width:160px">
                    <div class="label">Percent (0-100)</div>
                    <input class="input" id="mPercent" type="number" placeholder="5" />
                  </div>
                  <div class="field" style="flex:1;min-width:160px">
                    <div class="label">MaxRp</div>
                    <input class="input" id="mMaxRp" type="number" placeholder="2000" />
                  </div>
                </div>

                <div class="help">
                  Monthly promo dihitung setelah voucher (di engine). Kalau mau matiin: uncheck Enabled lalu Set.
                </div>
              </div>
            </div>

            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">Unlimited Device Key</div>
                <div class="row">
                  <button class="btn btnGhost" id="btnComputeDeviceKey" type="button">Compute</button>
                  <button class="btn btnPrimary" id="btnAddUnlimited" type="button">Add</button>
                  <button class="btn btnBad" id="btnRemoveUnlimited" type="button">Remove</button>
                </div>
              </div>
              <div class="cardBody grid" style="gap:12px">
                <div class="field">
                  <div class="label">Device ID (input)</div>
                  <input class="input" id="uDeviceId" placeholder="dev_xxx_yyy" />
                </div>
                <div class="field">
                  <div class="label">Pepper (harus sama dengan server: DEVICE_PEPPER)</div>
                  <input class="input" id="uPepper" placeholder="ISI_PEPPER" />
                </div>
                <div class="field">
                  <div class="label">Device Key (sha256(deviceId + '|' + pepper))</div>
                  <input class="input mono" id="uDeviceKey" placeholder="(hasil compute akan muncul di sini)" />
                </div>
                <div class="help">
                  API butuh <b>deviceKey</b> (bukan deviceId) untuk unlimited.
                  Kalau kamu belum tau pepper servernya, isi sama dengan env <span class="kbd">DEVICE_PEPPER</span> yang kamu set di Vercel.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- TX -->
        <section id="tab-tx" style="display:none">
          <div class="grid grid2">
            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">TX Tools (ADMIN)</div>
                <div class="row">
                  <button class="btn btnGhost" id="btnTxList" type="button">List</button>
                  <button class="btn btnGhost" id="btnTxSearch" type="button">Search</button>
                  <button class="btn btnGhost" id="btnTxGet" type="button">Get</button>
                  <button class="btn btnBad" id="btnTxClear" type="button">Clear</button>
                </div>
              </div>
              <div class="cardBody grid" style="gap:12px">
                <div class="row">
                  <div class="field" style="flex:1;min-width:170px">
                    <div class="label">List limit</div>
                    <input class="input" id="txLimit" type="number" value="200" />
                  </div>
                  <div class="field" style="flex:1;min-width:170px">
                    <div class="label">Get idTransaksi</div>
                    <input class="input" id="txId" placeholder="TRX123..." />
                  </div>
                </div>
                <div class="field">
                  <div class="label">Search query</div>
                  <input class="input" id="txQ" placeholder="pending / paid / nama / etc" />
                </div>
                <div class="help">
                  Actions:
                  <span class="kbd">tx.list</span>,
                  <span class="kbd">tx.search</span>,
                  <span class="kbd">tx.get</span>,
                  <span class="kbd">tx.clear</span>
                </div>
              </div>
            </div>

            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">TX Upsert (ADMIN)</div>
                <div class="row">
                  <button class="btn btnPrimary" id="btnTxUpsert" type="button">Upsert</button>
                </div>
              </div>
              <div class="cardBody grid" style="gap:10px">
                <div class="help">Isi JSON minimal harus punya <span class="kbd">idTransaksi</span></div>
                <textarea id="txJson" spellcheck="false" class="mono">{ "idTransaksi": "TRX_DEMO", "status": "pending", "note": "manual upsert" }</textarea>
              </div>
            </div>
          </div>
        </section>

        <!-- DISCOUNT TEST -->
        <section id="tab-discount" style="display:none">
          <div class="grid grid2">
            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">discount.apply</div>
                <div class="row">
                  <button class="btn btnPrimary" id="btnDiscountApply" type="button">Apply</button>
                </div>
              </div>
              <div class="cardBody grid" style="gap:12px">
                <div class="row">
                  <div class="field" style="flex:1;min-width:160px">
                    <div class="label">Amount</div>
                    <input class="input" id="dAmount" type="number" value="10000" />
                  </div>
                  <div class="field" style="flex:1;min-width:160px">
                    <div class="label">DeviceId</div>
                    <input class="input" id="dDeviceId" placeholder="dev_xxx_yyy" />
                  </div>
                </div>
                <div class="field">
                  <div class="label">Voucher Code (optional)</div>
                  <input class="input" id="dVoucher" placeholder="KINGLEV" />
                </div>
                <div class="help">
                  Ini buat ngetes engine:
                  - result berisi <span class="kbd">reservations</span>
                  - kalau transaksi selesai: call <span class="kbd">discount.commit</span>
                  - kalau dibatalin: call <span class="kbd">discount.release</span>
                </div>
              </div>
            </div>

            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">Commit / Release</div>
                <div class="row">
                  <button class="btn btnPrimary" id="btnDiscountCommit" type="button">Commit</button>
                  <button class="btn btnWarn" id="btnDiscountRelease" type="button">Release</button>
                </div>
              </div>
              <div class="cardBody grid" style="gap:10px">
                <div class="help">Paste array <span class="kbd">reservations</span> dari response apply.</div>
                <textarea id="dReservations" spellcheck="false" class="mono">[]</textarea>
              </div>
            </div>
          </div>
        </section>

        <!-- RAW -->
        <section id="tab-raw" style="display:none">
          <div class="grid grid2">
            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">Quick Call</div>
                <div class="row">
                  <button class="btn btnGhost" id="btnHelp" type="button">help</button>
                  <button class="btn btnGhost" id="btnPing2" type="button">ping</button>
                </div>
              </div>
              <div class="cardBody grid" style="gap:10px">
                <div class="field">
                  <div class="label">Action</div>
                  <input class="input mono" id="rawAction" placeholder="voucher.list" value="help" />
                </div>
                <div class="field">
                  <div class="label">Body (JSON)</div>
                  <textarea id="rawBody" spellcheck="false" class="mono">{}</textarea>
                </div>
                <div class="row">
                  <button class="btn btnPrimary" id="btnRawSend" type="button" style="flex:1">Send</button>
                </div>
                <div class="help">
                  Semua request di sini pakai POST JSON, ke:
                  <span class="kbd">/api/levpay?action=...</span>
                </div>
              </div>
            </div>

            <div class="card" style="margin:0">
              <div class="cardHead">
                <div class="cardTitle">Response</div>
                <div class="row">
                  <button class="btn btnGhost" id="btnCopyResp" type="button">Copy</button>
                  <button class="btn btnGhost" id="btnClearResp" type="button">Clear</button>
                </div>
              </div>
              <div class="cardBody">
                <textarea id="respBox" class="mono" spellcheck="false" style="min-height:340px">{}</textarea>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>

    <div class="muted" style="font-size:12px;font-weight:800;line-height:1.6;margin-top:10px">
      Catatan penting:
      <br>• Admin endpoints butuh header <span class="kbd">X-Admin-Key</span>.
      <br>• Kalau kamu deploy Vercel, pastikan env <span class="kbd">ADMIN_KEY</span> (dan kalau perlu <span class="kbd">DEVICE_PEPPER</span>) sudah diset.
    </div>
  </div>

  <script>
    (() => {
      const $ = (id) => document.getElementById(id);

      const LS = {
        host: "levpay_admin_host_v1",
        key: "levpay_admin_key_v1",
      };

      const state = {
        host: localStorage.getItem(LS.host) || "",
        key: localStorage.getItem(LS.key) || "",
        lastResponse: null,
        busy: false,
      };

      const ui = {
        connBase: $("connBase"),
        connAdmin: $("connAdmin"),
        connDot: $("connDot"),
        connText: $("connText"),

        toast: $("toast"),

        loginOverlay: $("loginOverlay"),
        loginHost: $("loginHost"),
        loginKey: $("loginKey"),

        respBox: $("respBox"),

        voucherTbody: $("voucherTbody"),

        // voucher form
        vCode: $("vCode"), vName: $("vName"), vPercent: $("vPercent"), vMaxRp: $("vMaxRp"),
        vMaxUses: $("vMaxUses"), vExpiresAt: $("vExpiresAt"), vNote: $("vNote"), vEnabled: $("vEnabled"),

        // monthly
        mEnabled: $("mEnabled"), mName: $("mName"), mPercent: $("mPercent"), mMaxRp: $("mMaxRp"),

        // unlimited
        uDeviceId: $("uDeviceId"), uPepper: $("uPepper"), uDeviceKey: $("uDeviceKey"),

        // tx
        txLimit: $("txLimit"), txId: $("txId"), txQ: $("txQ"), txJson: $("txJson"),

        // discount
        dAmount: $("dAmount"), dDeviceId: $("dDeviceId"), dVoucher: $("dVoucher"), dReservations: $("dReservations"),

        // raw
        rawAction: $("rawAction"), rawBody: $("rawBody"),
      };

      function toast(msg, tone="good"){
        if (!ui.toast) return;
        const t = String(msg || "");
        ui.toast.innerHTML = `<b>${tone.toUpperCase()}</b> <span class="muted">•</span> ${escapeHtml(t)}`;
        ui.toast.classList.add("isOn");
        setTimeout(() => ui.toast.classList.remove("isOn"), 2400);
      }

      function escapeHtml(s){
        return String(s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function setConnStatus(tone, text){
        const dot = ui.connDot;
        const txt = ui.connText;
        if (dot){
          dot.classList.remove("good","warn","bad");
          if (tone) dot.classList.add(tone);
        }
        if (txt) txt.textContent = text || "—";
      }

      function baseUrl(){
        const h = String(state.host || "").trim().replace(/\/+$/,"");
        if (h) return h;
        // default to current origin
        return location.origin;
      }

      function apiUrl(action){
        const b = baseUrl();
        return `${b}/api/levpay?action=${encodeURIComponent(String(action||"").trim())}`;
      }

      function setConnText(){
        ui.connBase.textContent = baseUrl();
        ui.connAdmin.textContent = state.key ? "SET" : "EMPTY";
      }

      async function request(action, body={}, { admin=false } = {}){
        const url = apiUrl(action);
        const headers = { "Content-Type":"application/json" };
        if (admin){
          if (!state.key) throw new Error("Admin key kosong. Klik Login/Settings dulu.");
          headers["X-Admin-Key"] = state.key;
        }

        const r = await fetch(url, {
          method: "POST",
          headers,
          body: JSON.stringify(body || {}),
          cache: "no-store",
        });

        const text = await r.text();
        let json = null;
        try { json = text ? JSON.parse(text) : {}; } catch { json = { success:false, raw:text }; }

        state.lastResponse = { url, status: r.status, ok: r.ok, data: json };
        ui.respBox.value = JSON.stringify(state.lastResponse, null, 2);

        return json;
      }

      // ---- sha256 helper (for unlimited device key) ----
      async function sha256Hex(str){
        const enc = new TextEncoder().encode(String(str||""));
        const buf = await crypto.subtle.digest("SHA-256", enc);
        const arr = Array.from(new Uint8Array(buf));
        return arr.map(b=>b.toString(16).padStart(2,"0")).join("");
      }

      // ---- tabs ----
      function setTab(name){
        document.querySelectorAll(".tab").forEach(el => {
          el.classList.toggle("isActive", el.dataset.tab === name);
        });
        const ids = ["vouchers","monthly","tx","discount","raw"];
        ids.forEach(id=>{
          const sec = document.getElementById("tab-"+id);
          if (sec) sec.style.display = (id===name) ? "" : "none";
        });
      }

      // ---- vouchers ----
      function voucherRow(v){
        const code = v?.code || "—";
        const enabled = v?.enabled !== false;
        const percent = Number(v?.percent || 0);
        const maxRp = Number(v?.maxRp || 0);
        const maxUses = (v?.maxUses == null) ? "∞" : String(v.maxUses);
        const uses = Number(v?.uses || 0);

        const badge = enabled
          ? `<span class="pill" style="border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.10)"><span class="dot good"></span> ON</span>`
          : `<span class="pill" style="border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.10)"><span class="dot bad"></span> OFF</span>`;

        return `
          <tr>
            <td class="mono"><b>${escapeHtml(code)}</b></td>
            <td>${escapeHtml(v?.name || code)}</td>
            <td>${percent}</td>
            <td class="mono">${maxRp}</td>
            <td class="mono">${escapeHtml(maxUses)}</td>
            <td class="mono">${uses}</td>
            <td>${badge}</td>
            <td>
              <div class="row" style="gap:8px">
                <button class="btn btnGhost" data-act="edit" data-code="${escapeHtml(code)}" type="button">Edit</button>
                <button class="btn btnBad" data-act="disable" data-code="${escapeHtml(code)}" type="button">Off</button>
              </div>
            </td>
          </tr>
        `;
      }

      async function loadVouchers(){
        setConnText();
        setConnStatus("warn", "Loading vouchers…");
        try{
          const res = await request("voucher.list", {}, { admin:true });
          const items = res?.data || [];
          if (!Array.isArray(items)) throw new Error("Response list tidak valid");
          ui.voucherTbody.innerHTML = items.length
            ? items.map(voucherRow).join("")
            : `<tr><td colspan="8" class="muted">Kosong.</td></tr>`;
          setConnStatus("good", `OK • ${items.length} voucher`);
          toast(`Loaded ${items.length} voucher`, "good");
        }catch(e){
          setConnStatus("bad", "Error");
          toast(e.message || "Gagal list voucher", "bad");
        }
      }

      function fillVoucherForm(v){
        ui.vCode.value = String(v?.code || "");
        ui.vName.value = String(v?.name || "");
        ui.vPercent.value = (v?.percent != null) ? String(v.percent) : "";
        ui.vMaxRp.value = (v?.maxRp != null) ? String(v.maxRp) : "";
        ui.vMaxUses.value = (v?.maxUses != null) ? String(v.maxUses) : "";
        ui.vExpiresAt.value = String(v?.expiresAt || "");
        ui.vNote.value = String(v?.note || "");
        ui.vEnabled.checked = (v?.enabled !== false);
      }

      async function voucherGet(){
        const code = String(ui.vCode.value || "").trim().toUpperCase();
        if (!code) return toast("Isi code dulu", "warn");
        try{
          const res = await request("voucher.get", { code }, { admin:true });
          if (!res?.success) throw new Error(res?.error || "voucher.get failed");
          fillVoucherForm(res.data || {});
          toast("Loaded voucher", "good");
        }catch(e){
          toast(e.message || "Gagal get voucher", "bad");
        }
      }

      async function voucherUpsert(){
        const code = String(ui.vCode.value || "").trim().toUpperCase();
        if (!code) return toast("Code wajib diisi", "warn");

        const body = {
          code,
          name: String(ui.vName.value || "").trim() || code,
          enabled: !!ui.vEnabled.checked,
          percent: Number(ui.vPercent.value || 0),
          maxRp: Number(ui.vMaxRp.value || 0),
          expiresAt: String(ui.vExpiresAt.value || "").trim() || null,
          note: String(ui.vNote.value || "").trim() || null,
        };

        const maxUsesRaw = String(ui.vMaxUses.value || "").trim();
        if (maxUsesRaw !== "") body.maxUses = Number(maxUsesRaw);

        try{
          const res = await request("voucher.upsert", body, { admin:true });
          if (!res?.success) throw new Error(res?.error || "voucher.upsert failed");
          toast("Upsert OK", "good");
          await loadVouchers();
        }catch(e){
          toast(e.message || "Gagal upsert", "bad");
        }
      }

      async function voucherDisable(codeOverride){
        const code = String(codeOverride || ui.vCode.value || "").trim().toUpperCase();
        if (!code) return toast("Code wajib diisi", "warn");

        const ok = confirm(`Off / disable voucher?\n\nCODE: ${code}`);
        if (!ok) return;

        try{
          const res = await request("voucher.disable", { code }, { admin:true });
          if (!res?.success) throw new Error(res?.error || "voucher.disable failed");
          toast("Voucher OFF", "good");
          await loadVouchers();
        }catch(e){
          toast(e.message || "Gagal disable", "bad");
        }
      }

      // ---- monthly ----
      async function monthlyGet(){
        try{
          const res = await request("monthly.get", {}, { admin:true });
          if (!res?.success) throw new Error(res?.error || "monthly.get failed");
          const p = res.data || {};
          ui.mEnabled.checked = !!p.enabled;
          ui.mName.value = String(p.name || "");
          ui.mPercent.value = (p.percent != null) ? String(p.percent) : "";
          ui.mMaxRp.value = (p.maxRp != null) ? String(p.maxRp) : "";
          toast("Monthly loaded", "good");
        }catch(e){
          toast(e.message || "Gagal monthly.get", "bad");
        }
      }

      async function monthlySet(){
        const body = {
          enabled: !!ui.mEnabled.checked,
          name: String(ui.mName.value || "").trim() || "PROMO BULANAN",
          percent: Number(ui.mPercent.value || 0),
          maxRp: Number(ui.mMaxRp.value || 0),
        };
        try{
          const res = await request("monthly.set", body, { admin:true });
          if (!res?.success) throw new Error(res?.error || "monthly.set failed");
          toast("Monthly updated", "good");
          await monthlyGet();
        }catch(e){
          toast(e.message || "Gagal monthly.set", "bad");
        }
      }

      async function computeDeviceKey(){
        const did = String(ui.uDeviceId.value || "").trim();
        const pepper = String(ui.uPepper.value || "").trim();
        if (!did) return toast("Isi deviceId dulu", "warn");
        if (!pepper) return toast("Isi pepper dulu", "warn");
        const key = await sha256Hex(did + "|" + pepper);
        ui.uDeviceKey.value = key;
        toast("Computed deviceKey", "good");
      }

      async function addUnlimited(){
        const k = String(ui.uDeviceKey.value || "").trim();
        if (!k) return toast("DeviceKey kosong", "warn");
        try{
          const res = await request("monthly.set", { addUnlimitedDeviceKey: k }, { admin:true });
          if (!res?.success) throw new Error(res?.error || "add unlimited failed");
          toast("Unlimited added", "good");
          await monthlyGet();
        }catch(e){
          toast(e.message || "Gagal add unlimited", "bad");
        }
      }

      async function removeUnlimited(){
        const k = String(ui.uDeviceKey.value || "").trim();
        if (!k) return toast("DeviceKey kosong", "warn");
        const ok = confirm("Remove unlimited untuk deviceKey ini?");
        if (!ok) return;
        try{
          const res = await request("monthly.set", { removeUnlimitedDeviceKey: k }, { admin:true });
          if (!res?.success) throw new Error(res?.error || "remove unlimited failed");
          toast("Unlimited removed", "good");
          await monthlyGet();
        }catch(e){
          toast(e.message || "Gagal remove unlimited", "bad");
        }
      }

      // ---- tx ----
      async function txList(){
        const limit = Number(ui.txLimit.value || 200);
        try{
          const res = await request("tx.list", { limit }, { admin:true });
          if (!res?.success) throw new Error(res?.error || "tx.list failed");
          toast(`TX list: ${Array.isArray(res.data) ? res.data.length : 0}`, "good");
        }catch(e){
          toast(e.message || "Gagal tx.list", "bad");
        }
      }

      async function txGet(){
        const idTransaksi = String(ui.txId.value || "").trim();
        if (!idTransaksi) return toast("Isi idTransaksi", "warn");
        try{
          const res = await request("tx.get", { idTransaksi }, { admin:true });
          if (!res?.success) throw new Error(res?.error || "tx.get failed");
          toast("TX loaded", "good");
        }catch(e){
          toast(e.message || "Gagal tx.get", "bad");
        }
      }

      async function txSearch(){
        const q = String(ui.txQ.value || "").trim();
        if (!q) return toast("Isi query", "warn");
        try{
          const res = await request("tx.search", { q }, { admin:true });
          if (!res?.success) throw new Error(res?.error || "tx.search failed");
          toast(`TX found: ${Array.isArray(res.data) ? res.data.length : 0}`, "good");
        }catch(e){
          toast(e.message || "Gagal tx.search", "bad");
        }
      }

      async function txClear(){
        const ok = confirm("Yakin mau CLEAR semua tx? (tx.clear)");
        if (!ok) return;
        try{
          const res = await request("tx.clear", {}, { admin:true });
          if (!res?.success) throw new Error(res?.error || "tx.clear failed");
          toast("TX cleared", "good");
        }catch(e){
          toast(e.message || "Gagal tx.clear", "bad");
        }
      }

      async function txUpsert(){
        let obj = {};
        try{ obj = JSON.parse(String(ui.txJson.value || "{}")); }catch{
          return toast("JSON invalid", "bad");
        }
        if (!obj?.idTransaksi && !obj?.id) return toast("JSON harus ada idTransaksi", "warn");
        try{
          const res = await request("tx.upsert", obj, { admin:true });
          if (!res?.success) throw new Error(res?.error || "tx.upsert failed");
          toast("TX upsert OK", "good");
        }catch(e){
          toast(e.message || "Gagal tx.upsert", "bad");
        }
      }

      // ---- discount test ----
      async function discountApply(){
        const amount = Number(ui.dAmount.value || 0);
        const deviceId = String(ui.dDeviceId.value || "").trim();
        const voucher = String(ui.dVoucher.value || "").trim();

        if (!amount || amount < 1) return toast("Amount invalid", "warn");

        try{
          const res = await request("discount.apply", {
            amount,
            deviceId,
            voucher,
          }, { admin:false }); // discount.apply gak butuh admin
          if (!res?.success) throw new Error(res?.error || "discount.apply failed");

          // auto copy reservations to box
          ui.dReservations.value = JSON.stringify(res?.data?.reservations || [], null, 2);
          toast("Apply OK", "good");
        }catch(e){
          toast(e.message || "Gagal apply", "bad");
        }
      }

      async function discountCommit(){
        let arr = [];
        try{ arr = JSON.parse(String(ui.dReservations.value || "[]")); }catch{
          return toast("Reservations JSON invalid", "bad");
        }
        if (!Array.isArray(arr)) return toast("Reservations harus array", "warn");
        try{
          const res = await request("discount.commit", { reservations: arr }, { admin:false });
          if (!res?.success) throw new Error(res?.error || "commit failed");
          toast("Commit OK", "good");
        }catch(e){
          toast(e.message || "Gagal commit", "bad");
        }
      }

      async function discountRelease(){
        let arr = [];
        try{ arr = JSON.parse(String(ui.dReservations.value || "[]")); }catch{
          return toast("Reservations JSON invalid", "bad");
        }
        if (!Array.isArray(arr)) return toast("Reservations harus array", "warn");
        try{
          const res = await request("discount.release", { reservations: arr }, { admin:false });
          if (!res?.success) throw new Error(res?.error || "release failed");
          toast("Release OK", "good");
        }catch(e){
          toast(e.message || "Gagal release", "bad");
        }
      }

      // ---- raw ----
      async function rawSend(){
        const action = String(ui.rawAction.value || "").trim();
        if (!action) return toast("Action kosong", "warn");

        let body = {};
        try{ body = JSON.parse(String(ui.rawBody.value || "{}")); }catch{
          return toast("Body JSON invalid", "bad");
        }
        const needAdmin = action.startsWith("voucher.") || action.startsWith("monthly.") || action.startsWith("tx.");
        try{
          const res = await request(action, body, { admin: needAdmin });
          if (res?.success) toast("OK", "good");
          else toast(res?.error || "Request done (success=false)", "warn");
        }catch(e){
          toast(e.message || "Request error", "bad");
        }
      }

      async function ping(){
        try{
          setConnStatus("warn", "Pinging…");
          const res = await request("ping", {}, { admin:false });
          if (!res?.success) throw new Error("ping failed");
          setConnStatus("good", "OK");
          toast("Ping OK", "good");
        }catch(e){
          setConnStatus("bad", "Error");
          toast(e.message || "Ping error", "bad");
        }
      }

      async function help(){
        try{
          const res = await request("help", {}, { admin:false });
          if (!res?.success) throw new Error("help failed");
          toast("Help loaded", "good");
        }catch(e){
          toast(e.message || "Help error", "bad");
        }
      }

      // ---- login overlay ----
      function openLogin(){
        ui.loginOverlay.classList.add("isOn");
        ui.loginOverlay.setAttribute("aria-hidden","false");
        ui.loginHost.value = state.host;
        ui.loginKey.value = state.key;
      }
      function closeLogin(){
        ui.loginOverlay.classList.remove("isOn");
        ui.loginOverlay.setAttribute("aria-hidden","true");
      }
      function saveLogin(){
        state.host = String(ui.loginHost.value || "").trim();
        state.key = String(ui.loginKey.value || "").trim();

        localStorage.setItem(LS.host, state.host);
        localStorage.setItem(LS.key, state.key);

        setConnText();
        toast("Saved settings", "good");
        closeLogin();
      }
      function clearLogin(){
        localStorage.removeItem(LS.host);
        localStorage.removeItem(LS.key);
        state.host = "";
        state.key = "";
        ui.loginHost.value = "";
        ui.loginKey.value = "";
        setConnText();
        toast("Reset done", "good");
      }

      // ---- events wiring ----
      $("tabs").addEventListener("click", (e) => {
        const t = e.target.closest(".tab");
        if (!t) return;
        setTab(t.dataset.tab);
      });

      $("btnOpenLogin").addEventListener("click", openLogin);
      $("btnCloseLogin").addEventListener("click", closeLogin);
      $("btnLogin").addEventListener("click", saveLogin);
      $("btnLoginClear").addEventListener("click", clearLogin);

      $("btnPing").addEventListener("click", ping);
      $("btnPing2").addEventListener("click", ping);
      $("btnHelp").addEventListener("click", help);
      $("btnReloadAll").addEventListener("click", async () => {
        await ping();
        await loadVouchers();
        await monthlyGet();
      });

      $("btnVoucherList").addEventListener("click", loadVouchers);
      $("btnVoucherGet").addEventListener("click", voucherGet);
      $("btnVoucherUpsert").addEventListener("click", voucherUpsert);
      $("btnVoucherDisable").addEventListener("click", () => voucherDisable());

      $("voucherTable").addEventListener("click", async (e) => {
        const b = e.target.closest("button[data-act]");
        if (!b) return;
        const act = b.dataset.act;
        const code = b.dataset.code;
        if (act === "disable") return voucherDisable(code);
        if (act === "edit"){
          ui.vCode.value = String(code || "");
          await voucherGet();
        }
      });

      $("btnMonthlyGet").addEventListener("click", monthlyGet);
      $("btnMonthlySet").addEventListener("click", monthlySet);

      $("btnComputeDeviceKey").addEventListener("click", computeDeviceKey);
      $("btnAddUnlimited").addEventListener("click", addUnlimited);
      $("btnRemoveUnlimited").addEventListener("click", removeUnlimited);

      $("btnTxList").addEventListener("click", txList);
      $("btnTxSearch").addEventListener("click", txSearch);
      $("btnTxGet").addEventListener("click", txGet);
      $("btnTxClear").addEventListener("click", txClear);
      $("btnTxUpsert").addEventListener("click", txUpsert);

      $("btnDiscountApply").addEventListener("click", discountApply);
      $("btnDiscountCommit").addEventListener("click", discountCommit);
      $("btnDiscountRelease").addEventListener("click", discountRelease);

      $("btnRawSend").addEventListener("click", rawSend);
      $("btnCopyResp").addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(ui.respBox.value || "");
          toast("Copied", "good");
        }catch{
          toast("Copy gagal", "bad");
        }
      });
      $("btnClearResp").addEventListener("click", () => {
        ui.respBox.value = "{}";
        toast("Cleared", "good");
      });

      // init
      setConnText();
      (async () => {
        // auto ping; kalau key kosong, biarin aja (user bisa login)
        await ping();
        // auto load list biar keliatan cepat
        try { await loadVouchers(); } catch {}
        try { await monthlyGet(); } catch {}
      })();

      // if opened as file://, show login to set host
      if (location.protocol === "file:") openLogin();
    })();
  </script>
</body>
</html>
```0