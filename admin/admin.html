<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LevPay Admin</title>
  <style>
    :root{
      --bg:#0b1020; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.04);
      --bd:rgba(255,255,255,.10); --bd2:rgba(255,255,255,.14);
      --txt:#eaf0ff; --mut:rgba(234,240,255,.72); --mut2:rgba(234,240,255,.55);
      --ok:#22c55e; --warn:#f97316; --bad:#ef4444; --pri1:#7c3aed; --pri2:#22d3ee;
      --r:18px;
      --sh: 0 18px 50px rgba(0,0,0,.35);
      font-synthesis-weight:none;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(124,58,237,.35), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(34,211,238,.22), transparent 50%),
                  var(--bg);
      color:var(--txt);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 34px}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin:6px 0 14px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
      padding:10px 12px; border:1px solid var(--bd); border-radius:999px;
      background: rgba(255,255,255,.04);
      box-shadow: var(--sh);
    }
    .dot{
      width:10px;height:10px;border-radius:99px;background:rgba(148,163,184,.9);
      box-shadow: 0 10px 18px rgba(0,0,0,.25);
    }
    .dot.ok{background:rgba(34,197,94,.95)}
    .dot.bad{background:rgba(239,68,68,.95)}
    .title{font-weight:1000; letter-spacing:-.02em}
    .subtitle{color:var(--mut2);font-weight:800;font-size:12px;margin-top:2px}
    .card{
      border-radius:22px;
      border:1px solid var(--bd);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--sh);
      overflow:hidden;
      margin-top:12px;
    }
    .head{
      padding:14px 14px 10px;
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .head h2{margin:0;font-size:15px;font-weight:1100}
    .row{display:grid; grid-template-columns:1fr; gap:10px; padding:14px}
    @media (min-width:880px){ .row.cols2{grid-template-columns:1.05fr .95fr} }
    .grid{
      display:grid; gap:10px;
      grid-template-columns: repeat(12, minmax(0,1fr));
    }
    .field{grid-column: span 12}
    @media (min-width:680px){
      .field.c6{grid-column: span 6}
      .field.c4{grid-column: span 4}
      .field.c3{grid-column: span 3}
      .field.c8{grid-column: span 8}
    }
    label{display:block;color:var(--mut);font-weight:1000;font-size:12px;margin:0 0 8px}
    input, textarea, select{
      width:100%;
      border-radius:16px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.04);
      padding:12px 12px;
      color:var(--txt);
      outline:none;
      font-weight:900;
    }
    textarea{min-height:120px;resize:vertical;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    input::placeholder, textarea::placeholder{color:rgba(234,240,255,.35);font-weight:800}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:none;
      border-radius:16px;
      padding:12px 12px;
      font-weight:1000;
      cursor:pointer;
      color:var(--txt);
      background: rgba(255,255,255,.05);
      border:1px solid var(--bd);
      transition:.14s ease;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:hover{transform:translateY(-1px);border-color:var(--bd2)}
    .btn:active{transform:translateY(0)}
    .btn.pri{
      color:#08101f;
      background: linear-gradient(90deg, var(--pri1), var(--pri2));
      border:none;
      box-shadow: 0 14px 34px rgba(34,211,238,.18);
    }
    .btn.bad{background: rgba(239,68,68,.16); border-color: rgba(239,68,68,.35)}
    .btn.warn{background: rgba(249,115,22,.14); border-color: rgba(249,115,22,.35)}
    .pill{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.04);
      font-weight:1000;
      font-size:12px;
      color:var(--mut);
    }
    .pill.ok{border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.12); color: rgba(209,255,224,.95)}
    .pill.bad{border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.12); color: rgba(255,220,220,.95)}
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:12px 14px 0;
    }
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.04);
      font-weight:1000;
      font-size:12px;
      cursor:pointer;
    }
    .tab.is-on{background: rgba(124,58,237,.16); border-color: rgba(124,58,237,.35)}
    .pane{display:none}
    .pane.is-on{display:block}
    .muted{color:var(--mut2);font-weight:800;font-size:12px;line-height:1.5}
    table{width:100%;border-collapse:collapse}
    th, td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
    th{color:var(--mut);font-size:12px;text-align:left;font-weight:1100}
    td{font-weight:900}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .small{font-size:12px}
    .sticky{
      position:sticky; top:10px;
      border-radius:22px;
      border:1px solid var(--bd);
      background: rgba(10,13,22,.70);
      backdrop-filter: blur(10px);
      box-shadow: var(--sh);
      overflow:hidden;
    }
    .logHead{padding:12px 12px 10px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .logHead b{font-weight:1100}
    pre{
      margin:0;
      padding:12px;
      max-height: 520px;
      overflow:auto;
      background: rgba(255,255,255,.03);
      color: rgba(234,240,255,.9);
      font-size:12px;
      line-height:1.55;
    }
    code{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
    .sep{height:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <span class="dot" id="dot"></span>
        <div>
          <div class="title">LevPay Admin</div>
          <div class="subtitle" id="sub">Ready</div>
        </div>
      </div>
      <div class="pill" id="pill">Not connected</div>
    </div>

    <div class="card">
      <div class="head">
        <h2>Connection</h2>
        <div class="btnRow">
          <button class="btn pri" id="btnPing">Ping</button>
          <button class="btn" id="btnSaveCfg">Save</button>
          <button class="btn bad" id="btnClearCfg">Clear</button>
        </div>
      </div>
      <div class="row">
        <div class="grid">
          <div class="field c8">
            <label>API Base URL</label>
            <input id="apiBase" placeholder="https://levpay-api.vercel.app/api/levpay" />
            <div class="muted">Contoh: <span class="mono">https://levpay-api.vercel.app/api/levpay</span></div>
          </div>
          <div class="field c4">
            <label>Admin Key (X-Admin-Key)</label>
            <input id="adminKey" placeholder="LEVIN6824" />
            <div class="muted">Disimpan di <span class="mono">localStorage</span> (browser lu).</div>
          </div>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab is-on" data-tab="voucher">Voucher</div>
        <div class="tab" data-tab="monthly">Monthly</div>
        <div class="tab" data-tab="tx">TX</div>
        <div class="tab" data-tab="tester">Tester</div>
        <div class="tab" data-tab="curl">Curl</div>
      </div>

      <!-- Voucher -->
      <div class="pane is-on" id="pane-voucher">
        <div class="row cols2">
          <div>
            <div class="grid">
              <div class="field c6">
                <label>Code</label>
                <input id="v_code" placeholder="KINGLEV" />
              </div>
              <div class="field c6">
                <label>Name</label>
                <input id="v_name" placeholder="KINGLEV 60%" />
              </div>
              <div class="field c4">
                <label>Percent</label>
                <input id="v_percent" type="number" min="0" max="100" placeholder="60" />
              </div>
              <div class="field c4">
                <label>Max Rp (0 = unlimited)</label>
                <input id="v_maxRp" type="number" min="0" placeholder="0" />
              </div>
              <div class="field c4">
                <label>Max Uses (kosong = unlimited)</label>
                <input id="v_maxUses" type="number" min="0" placeholder="" />
              </div>
              <div class="field c6">
                <label>Expires At (ISO) optional</label>
                <input id="v_expiresAt" placeholder="2026-01-31T00:00:00.000Z" />
              </div>
              <div class="field c6">
                <label>Enabled</label>
                <select id="v_enabled">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <div class="field">
                <label>Note</label>
                <input id="v_note" placeholder="catatan opsional" />
              </div>
            </div>

            <div class="sep"></div>

            <div class="btnRow">
              <button class="btn pri" id="btnVoucherUpsert">voucher.upsert</button>
              <button class="btn warn" id="btnVoucherDisable">voucher.disable</button>
              <button class="btn" id="btnVoucherGet">voucher.get</button>
              <button class="btn" id="btnVoucherList">voucher.list</button>
            </div>

            <div class="sep"></div>
            <div class="muted">
              Kalau voucher “kadang ilang”, itu biasanya karena storage backend lu masih <span class="mono">/tmp</span> (serverless instance beda).
              Solusinya: pindahin DB ke KV/Supabase (biar persistent).
            </div>
          </div>

          <div class="sticky">
            <div class="logHead">
              <b>Voucher List (preview)</b>
              <span class="pill" id="voucherCount">0</span>
            </div>
            <div style="padding:0 12px 12px;">
              <table>
                <thead>
                  <tr>
                    <th>Code</th>
                    <th>Name</th>
                    <th>%</th>
                    <th>MaxRp</th>
                    <th>Enabled</th>
                    <th>Uses</th>
                  </tr>
                </thead>
                <tbody id="voucherTable">
                  <tr><td colspan="6" class="muted small">Klik <b>voucher.list</b> buat isi tabel.</td></tr>
                </tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <!-- Monthly -->
      <div class="pane" id="pane-monthly">
        <div class="row cols2">
          <div>
            <div class="grid">
              <div class="field c6">
                <label>Enabled</label>
                <select id="m_enabled">
                  <option value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <div class="field c6">
                <label>Name</label>
                <input id="m_name" placeholder="PROMO BULANAN" />
              </div>
              <div class="field c6">
                <label>Percent</label>
                <input id="m_percent" type="number" min="0" max="100" placeholder="5" />
              </div>
              <div class="field c6">
                <label>Max Rp</label>
                <input id="m_maxRp" type="number" min="0" placeholder="2000" />
              </div>

              <div class="field">
                <label>Unlimited DeviceKey</label>
                <div class="muted">Yang dipake API itu <b>deviceKey</b> = SHA256(<span class="mono">deviceId + "|" + pepper</span>).</div>
              </div>

              <div class="field c6">
                <label>DeviceId (buat dihitung jadi deviceKey)</label>
                <input id="u_deviceId" placeholder="DEVICE-123" />
              </div>
              <div class="field c6">
                <label>Pepper (harus sama kayak backend)</label>
                <input id="u_pepper" placeholder="ISI_PEPPER" />
              </div>
              <div class="field c12">
                <label>Computed deviceKey (SHA256)</label>
                <input id="u_deviceKey" class="mono" readonly placeholder="(klik Compute)" />
              </div>

              <div class="field c6">
                <label>Add Unlimited DeviceKey</label>
                <input id="u_add" class="mono" placeholder="paste deviceKey" />
              </div>
              <div class="field c6">
                <label>Remove Unlimited DeviceKey</label>
                <input id="u_remove" class="mono" placeholder="paste deviceKey" />
              </div>
            </div>

            <div class="sep"></div>

            <div class="btnRow">
              <button class="btn" id="btnMonthlyGet">monthly.get</button>
              <button class="btn pri" id="btnMonthlySet">monthly.set</button>
              <button class="btn" id="btnComputeKey">Compute SHA256</button>
            </div>
          </div>

          <div class="sticky">
            <div class="logHead">
              <b>Monthly (raw)</b>
              <span class="pill" id="monthlyPill">—</span>
            </div>
            <pre id="monthlyRaw" class="mono">{}</pre>
          </div>
        </div>
      </div>

      <!-- TX -->
      <div class="pane" id="pane-tx">
        <div class="row cols2">
          <div>
            <div class="grid">
              <div class="field c8">
                <label>TX Id (idTransaksi)</label>
                <input id="t_id" placeholder="LEV..." />
              </div>
              <div class="field c4">
                <label>Limit</label>
                <input id="t_limit" type="number" min="1" max="1000" placeholder="200" value="200" />
              </div>
              <div class="field">
                <label>Search query (tx.search)</label>
                <input id="t_q" placeholder="keyword..." />
              </div>
              <div class="field">
                <label>Upsert payload (tx.upsert)</label>
                <textarea id="t_body" class="mono" placeholder='{"idTransaksi":"LEV123","status":"paid"}'></textarea>
              </div>
            </div>

            <div class="sep"></div>

            <div class="btnRow">
              <button class="btn" id="btnTxGet">tx.get</button>
              <button class="btn" id="btnTxList">tx.list</button>
              <button class="btn" id="btnTxSearch">tx.search</button>
              <button class="btn pri" id="btnTxUpsert">tx.upsert</button>
              <button class="btn bad" id="btnTxClear">tx.clear</button>
            </div>
          </div>

          <div class="sticky">
            <div class="logHead">
              <b>TX Result</b>
              <span class="pill" id="txPill">—</span>
            </div>
            <pre id="txRaw" class="mono">{}</pre>
          </div>
        </div>
      </div>

      <!-- Tester -->
      <div class="pane" id="pane-tester">
        <div class="row cols2">
          <div>
            <div class="grid">
              <div class="field c6">
                <label>Amount</label>
                <input id="x_amount" type="number" min="1" placeholder="10000" value="10000" />
              </div>
              <div class="field c6">
                <label>DeviceId</label>
                <input id="x_deviceId" placeholder="DEVICE-123" value="DEVICE-123" />
              </div>
              <div class="field c6">
                <label>Voucher</label>
                <input id="x_voucher" placeholder="KINGLEV" value="KINGLEV" />
              </div>
              <div class="field c6">
                <label>Reserve TTL (ms)</label>
                <input id="x_ttl" type="number" min="1000" placeholder="360000" value="360000" />
              </div>
            </div>
            <div class="sep"></div>
            <div class="btnRow">
              <button class="btn pri" id="btnDiscountApply">discount.apply</button>
              <button class="btn" id="btnDiscountCommit">discount.commit</button>
              <button class="btn" id="btnDiscountRelease">discount.release</button>
            </div>
            <div class="sep"></div>
            <div class="muted">
              <b>Kalau “voucher udah di upsert tapi apply ga kepotong”</b>: cek dulu <span class="mono">voucher.get</span> & <span class="mono">voucher.list</span>.
              Kalau list kadang kosong, berarti DB backend lu reset (serverless /tmp).
            </div>
          </div>

          <div class="sticky">
            <div class="logHead">
              <b>Discount Result</b>
              <span class="pill" id="discPill">—</span>
            </div>
            <pre id="discRaw" class="mono">{}</pre>
          </div>
        </div>
      </div>

      <!-- Curl -->
      <div class="pane" id="pane-curl">
        <div class="row cols2">
          <div>
            <div class="grid">
              <div class="field">
                <label>Generate Curl (Termux)</label>
                <select id="c_kind">
                  <option value="voucher.upsert">voucher.upsert</option>
                  <option value="voucher.disable">voucher.disable</option>
                  <option value="voucher.list">voucher.list</option>
                  <option value="voucher.get">voucher.get</option>
                  <option value="monthly.get">monthly.get</option>
                  <option value="monthly.set">monthly.set</option>
                  <option value="discount.apply">discount.apply</option>
                </select>
              </div>
              <div class="field">
                <label>Payload JSON (optional)</label>
                <textarea id="c_body" class="mono" placeholder='{"code":"KINGLEV","percent":60,"maxRp":0,"enabled":true}'></textarea>
              </div>
            </div>
            <div class="btnRow">
              <button class="btn pri" id="btnGenCurl">Generate</button>
              <button class="btn" id="btnCopyCurl">Copy</button>
            </div>
          </div>

          <div class="sticky">
            <div class="logHead">
              <b>Curl Output</b>
              <span class="pill">Termux</span>
            </div>
            <pre id="curlOut" class="mono"></pre>
          </div>
        </div>
      </div>

    </div>

    <div class="card" style="margin-top:12px">
      <div class="head">
        <h2>Response Log</h2>
        <div class="btnRow">
          <button class="btn" id="btnClearLog">Clear</button>
        </div>
      </div>
      <pre id="log" class="mono"></pre>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const dot = $("dot");
  const pill = $("pill");
  const sub = $("sub");
  const logEl = $("log");

  const apiBaseEl = $("apiBase");
  const adminKeyEl = $("adminKey");

  const tabs = $("tabs");
  const panes = {
    voucher: $("pane-voucher"),
    monthly: $("pane-monthly"),
    tx: $("pane-tx"),
    tester: $("pane-tester"),
    curl: $("pane-curl"),
  };

  const voucherTable = $("voucherTable");
  const voucherCount = $("voucherCount");
  const monthlyRaw = $("monthlyRaw");
  const monthlyPill = $("monthlyPill");
  const txRaw = $("txRaw");
  const txPill = $("txPill");
  const discRaw = $("discRaw");
  const discPill = $("discPill");
  const curlOut = $("curlOut");

  function now() {
    return new Date().toLocaleString("id-ID", { hour12:false });
  }

  function setStatus(ok, text) {
    dot.classList.remove("ok","bad");
    pill.classList.remove("ok","bad");
    if (ok === true) { dot.classList.add("ok"); pill.classList.add("ok"); }
    if (ok === false) { dot.classList.add("bad"); pill.classList.add("bad"); }
    pill.textContent = text || (ok ? "Connected" : "Not connected");
    sub.textContent = text || (ok ? "Connected" : "Ready");
  }

  function log(title, obj) {
    const s = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    logEl.textContent = `[${now()}] ${title}\n${s}\n\n` + logEl.textContent;
  }

  function saveCfg() {
    localStorage.setItem("levpay_admin_base", apiBaseEl.value.trim());
    localStorage.setItem("levpay_admin_key", adminKeyEl.value.trim());
    log("Saved config", { base: apiBaseEl.value.trim(), key: adminKeyEl.value.trim() ? "(set)" : "(empty)" });
  }

  function loadCfg() {
    const base = localStorage.getItem("levpay_admin_base") || "";
    const key = localStorage.getItem("levpay_admin_key") || "";
    apiBaseEl.value = base || (location.origin + "/api/levpay");
    adminKeyEl.value = key;
  }

  function clearCfg() {
    localStorage.removeItem("levpay_admin_base");
    localStorage.removeItem("levpay_admin_key");
    loadCfg();
    log("Cleared config", {});
  }

  function baseUrl() {
    let b = (apiBaseEl.value || "").trim();
    if (!b) b = location.origin + "/api/levpay";
    return b.replace(/\/+$/,"");
  }

  async function api(action, body = {}, { admin = false } = {}) {
    const url = `${baseUrl()}?action=${encodeURIComponent(action)}`;
    const headers = { "Content-Type": "application/json" };
    const adminKey = (adminKeyEl.value || "").trim();
    if (admin && adminKey) headers["X-Admin-Key"] = adminKey;

    const res = await fetch(url, {
      method: "POST",
      headers,
      body: JSON.stringify(body || {}),
    });

    const text = await res.text();
    let json = null;
    try { json = text ? JSON.parse(text) : {}; } catch { json = { raw: text }; }

    if (!res.ok) {
      const err = new Error(`HTTP ${res.status}`);
      err.data = json;
      throw err;
    }
    return json;
  }

  function asBool(v){ return String(v) === "true"; }
  function asNum(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }

  // Tabs
  tabs.addEventListener("click", (e) => {
    const t = e.target?.closest?.(".tab");
    if (!t) return;
    const name = t.dataset.tab;
    [...tabs.querySelectorAll(".tab")].forEach(x => x.classList.toggle("is-on", x === t));
    Object.entries(panes).forEach(([k, el]) => el.classList.toggle("is-on", k === name));
  });

  // Ping
  $("btnPing").addEventListener("click", async () => {
    try {
      const out = await api("ping", {}, { admin:false });
      setStatus(true, "Ping OK");
      log("ping", out);
    } catch (e) {
      setStatus(false, "Ping FAILED");
      log("ping ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnSaveCfg").addEventListener("click", saveCfg);
  $("btnClearCfg").addEventListener("click", clearCfg);
  $("btnClearLog").addEventListener("click", () => logEl.textContent = "");

  // Voucher ops
  function readVoucherForm(){
    const code = ($("v_code").value || "").trim().toUpperCase();
    return {
      code,
      name: ($("v_name").value || "").trim(),
      enabled: asBool($("v_enabled").value),
      percent: asNum($("v_percent").value) ?? 0,
      maxRp: asNum($("v_maxRp").value) ?? 0,
      maxUses: ($("v_maxUses").value || "").trim() === "" ? undefined : asNum($("v_maxUses").value),
      expiresAt: ($("v_expiresAt").value || "").trim() || null,
      note: ($("v_note").value || "").trim() || null,
    };
  }

  function renderVoucherTable(items){
    const arr = Array.isArray(items) ? items : [];
    voucherCount.textContent = String(arr.length);
    if (!arr.length){
      voucherTable.innerHTML = `<tr><td colspan="6" class="muted small">Kosong. (Atau DB backend lu ke-reset)</td></tr>`;
      return;
    }
    voucherTable.innerHTML = arr.map(v => `
      <tr>
        <td class="mono small">${escapeHtml(v.code || "")}</td>
        <td class="small">${escapeHtml(v.name || "")}</td>
        <td>${escapeHtml(String(v.percent ?? ""))}</td>
        <td class="small">${escapeHtml(String(v.maxRp ?? ""))}</td>
        <td>${v.enabled === false ? "false" : "true"}</td>
        <td class="small">${escapeHtml(String(v.uses ?? 0))}</td>
      </tr>
    `).join("");
  }

  function escapeHtml(s){
    return String(s || "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  $("btnVoucherUpsert").addEventListener("click", async () => {
    try {
      const payload = readVoucherForm();
      if (!payload.code) return log("voucher.upsert", "code required");
      const out = await api("voucher.upsert", payload, { admin:true });
      log("voucher.upsert", out);
      setStatus(true, "Saved voucher");
    } catch (e) {
      setStatus(false, "voucher.upsert FAILED");
      log("voucher.upsert ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnVoucherDisable").addEventListener("click", async () => {
    try {
      const code = ($("v_code").value || "").trim().toUpperCase();
      if (!code) return log("voucher.disable", "code required");
      const out = await api("voucher.disable", { code }, { admin:true });
      log("voucher.disable", out);
      setStatus(true, "Disabled voucher");
    } catch (e) {
      setStatus(false, "voucher.disable FAILED");
      log("voucher.disable ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnVoucherGet").addEventListener("click", async () => {
    try {
      const code = ($("v_code").value || "").trim().toUpperCase();
      if (!code) return log("voucher.get", "code required");
      const out = await api("voucher.get", { code }, { admin:true });
      log("voucher.get", out);
      setStatus(true, "Got voucher");
    } catch (e) {
      setStatus(false, "voucher.get FAILED");
      log("voucher.get ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnVoucherList").addEventListener("click", async () => {
    try {
      const out = await api("voucher.list", {}, { admin:true });
      log("voucher.list", out);
      renderVoucherTable(out?.data || []);
      setStatus(true, "Listed vouchers");
    } catch (e) {
      setStatus(false, "voucher.list FAILED");
      renderVoucherTable([]);
      log("voucher.list ERROR", { message: e.message, data: e.data || null });
    }
  });

  // Monthly
  $("btnMonthlyGet").addEventListener("click", async () => {
    try {
      const out = await api("monthly.get", {}, { admin:true });
      log("monthly.get", out);
      monthlyRaw.textContent = JSON.stringify(out, null, 2);
      monthlyPill.textContent = out?.success ? "OK" : "—";
      if (out?.data){
        $("m_enabled").value = String(!!out.data.enabled);
        $("m_name").value = out.data.name || "";
        $("m_percent").value = String(out.data.percent ?? "");
        $("m_maxRp").value = String(out.data.maxRp ?? "");
      }
      setStatus(true, "Monthly loaded");
    } catch (e) {
      setStatus(false, "monthly.get FAILED");
      log("monthly.get ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnMonthlySet").addEventListener("click", async () => {
    try {
      const body = {
        enabled: asBool($("m_enabled").value),
        name: ($("m_name").value || "").trim(),
        percent: asNum($("m_percent").value) ?? 0,
        maxRp: asNum($("m_maxRp").value) ?? 0,
      };
      const add = ($("u_add").value || "").trim();
      const rem = ($("u_remove").value || "").trim();
      if (add) body.addUnlimitedDeviceKey = add;
      if (rem) body.removeUnlimitedDeviceKey = rem;

      const out = await api("monthly.set", body, { admin:true });
      log("monthly.set", out);
      monthlyRaw.textContent = JSON.stringify(out, null, 2);
      monthlyPill.textContent = out?.success ? "OK" : "—";
      setStatus(true, "Monthly saved");
    } catch (e) {
      setStatus(false, "monthly.set FAILED");
      log("monthly.set ERROR", { message: e.message, data: e.data || null });
    }
  });

  async function sha256Hex(text){
    const enc = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest("SHA-256", enc);
    const arr = Array.from(new Uint8Array(buf));
    return arr.map(b => b.toString(16).padStart(2,"0")).join("");
  }

  $("btnComputeKey").addEventListener("click", async () => {
    try{
      const deviceId = ($("u_deviceId").value || "");
      const pepper = ($("u_pepper").value || "");
      const key = await sha256Hex(deviceId + "|" + pepper);
      $("u_deviceKey").value = key;
      $("u_add").value = key;
      log("compute deviceKey", { deviceId, pepper: pepper ? "(set)" : "(empty)", deviceKey: key });
    } catch(e){
      log("compute ERROR", e.message || String(e));
    }
  });

  // TX ops
  $("btnTxGet").addEventListener("click", async () => {
    try {
      const idTransaksi = ($("t_id").value || "").trim();
      if (!idTransaksi) return log("tx.get", "idTransaksi required");
      const out = await api("tx.get", { idTransaksi }, { admin:true });
      txRaw.textContent = JSON.stringify(out, null, 2);
      txPill.textContent = "OK";
      log("tx.get", out);
      setStatus(true, "TX get OK");
    } catch (e) {
      txPill.textContent = "ERR";
      setStatus(false, "tx.get FAILED");
      log("tx.get ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnTxList").addEventListener("click", async () => {
    try {
      const limit = asNum($("t_limit").value) ?? 200;
      const out = await api("tx.list", { limit }, { admin:true });
      txRaw.textContent = JSON.stringify(out, null, 2);
      txPill.textContent = "OK";
      log("tx.list", out);
      setStatus(true, "TX list OK");
    } catch (e) {
      txPill.textContent = "ERR";
      setStatus(false, "tx.list FAILED");
      log("tx.list ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnTxSearch").addEventListener("click", async () => {
    try {
      const q = ($("t_q").value || "").trim();
      if (!q) return log("tx.search", "q required");
      const out = await api("tx.search", { q }, { admin:true });
      txRaw.textContent = JSON.stringify(out, null, 2);
      txPill.textContent = "OK";
      log("tx.search", out);
      setStatus(true, "TX search OK");
    } catch (e) {
      txPill.textContent = "ERR";
      setStatus(false, "tx.search FAILED");
      log("tx.search ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnTxUpsert").addEventListener("click", async () => {
    try {
      const raw = ($("t_body").value || "").trim();
      if (!raw) return log("tx.upsert", "payload required");
      let body = {};
      try { body = JSON.parse(raw); } catch { return log("tx.upsert", "JSON invalid"); }
      const out = await api("tx.upsert", body, { admin:true });
      txRaw.textContent = JSON.stringify(out, null, 2);
      txPill.textContent = "OK";
      log("tx.upsert", out);
      setStatus(true, "TX upsert OK");
    } catch (e) {
      txPill.textContent = "ERR";
      setStatus(false, "tx.upsert FAILED");
      log("tx.upsert ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnTxClear").addEventListener("click", async () => {
    try {
      const ok = confirm("Yakin tx.clear? Semua tx kehapus.");
      if (!ok) return;
      const out = await api("tx.clear", {}, { admin:true });
      txRaw.textContent = JSON.stringify(out, null, 2);
      txPill.textContent = "OK";
      log("tx.clear", out);
      setStatus(true, "TX cleared");
    } catch (e) {
      txPill.textContent = "ERR";
      setStatus(false, "tx.clear FAILED");
      log("tx.clear ERROR", { message: e.message, data: e.data || null });
    }
  });

  // Discount tester
  let lastReservations = [];
  $("btnDiscountApply").addEventListener("click", async () => {
    try {
      const amount = asNum($("x_amount").value) ?? 0;
      const deviceId = ($("x_deviceId").value || "").trim();
      const voucher = ($("x_voucher").value || "").trim();
      const reserveTtlMs = asNum($("x_ttl").value) ?? (6*60*1000);

      const out = await api("discount.apply", { amount, deviceId, voucher, reserveTtlMs }, { admin:false });
      discRaw.textContent = JSON.stringify(out, null, 2);
      discPill.textContent = out?.success ? "OK" : "—";
      lastReservations = out?.data?.reservations || [];
      log("discount.apply", out);
      setStatus(true, "Discount apply OK");
    } catch (e) {
      discPill.textContent = "ERR";
      setStatus(false, "discount.apply FAILED");
      log("discount.apply ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnDiscountCommit").addEventListener("click", async () => {
    try {
      const out = await api("discount.commit", { reservations: lastReservations }, { admin:false });
      discRaw.textContent = JSON.stringify(out, null, 2);
      discPill.textContent = "OK";
      log("discount.commit", out);
      setStatus(true, "Commit OK");
    } catch (e) {
      discPill.textContent = "ERR";
      setStatus(false, "discount.commit FAILED");
      log("discount.commit ERROR", { message: e.message, data: e.data || null });
    }
  });

  $("btnDiscountRelease").addEventListener("click", async () => {
    try {
      const out = await api("discount.release", { reservations: lastReservations }, { admin:false });
      discRaw.textContent = JSON.stringify(out, null, 2);
      discPill.textContent = "OK";
      log("discount.release", out);
      setStatus(true, "Release OK");
    } catch (e) {
      discPill.textContent = "ERR";
      setStatus(false, "discount.release FAILED");
      log("discount.release ERROR", { message: e.message, data: e.data || null });
    }
  });

  // Curl generator
  $("btnGenCurl").addEventListener("click", () => {
    const action = $("c_kind").value;
    const base = baseUrl();
    const key = (adminKeyEl.value || "").trim();

    let payload = {};
    const raw = ($("c_body").value || "").trim();
    if (raw){
      try { payload = JSON.parse(raw); }
      catch { payload = raw; }
    }

    const isAdminAction = action.startsWith("voucher.") || action.startsWith("monthly.") || action.startsWith("tx.");
    const headers = [
      `-H 'Content-Type: application/json'`,
      isAdminAction ? `-H 'X-Admin-Key: ${key || "LEVIN6824"}'` : null,
    ].filter(Boolean).join(" \\\n  ");

    const data = typeof payload === "string"
      ? payload
      : JSON.stringify(payload || {}, null, 0);

    curlOut.textContent =
`curl -sS -X POST '${base}?action=${encodeURIComponent(action)}' \\
  ${headers} \\
  --data-raw '${data}'`;
  });

  $("btnCopyCurl").addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(curlOut.textContent || "");
      log("copy curl", { ok:true });
    }catch{
      log("copy curl", { ok:false });
    }
  });

  // Init
  loadCfg();
  setStatus(null, "Not connected");
})();
</script>
</body>
</html>