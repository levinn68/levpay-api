<!-- admin/admin.html
  Admin Panel (targets: /api/orkut?action=...)
  - Modal input Admin Key (blur background until valid)
  - Voucher upsert/disable
  - Monthly promo settings + unlimited deviceKey tools
  - DeviceId generator + curl snippets
-->
<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LevPay Admin</title>
  <style>
    :root{
      --bg0:#070912;
      --bg1:#0b1022;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.04);
      --bd: rgba(255,255,255,.10);
      --bd2: rgba(255,255,255,.14);
      --txt: rgba(245,248,255,.92);
      --mut: rgba(245,248,255,.62);
      --mut2: rgba(245,248,255,.48);
      --ok: rgba(34,197,94,1);
      --warn: rgba(245,158,11,1);
      --bad: rgba(239,68,68,1);
      --c1: rgba(124,58,237,1);
      --c2: rgba(34,211,238,1);
      --r1: 18px;
      --r2: 24px;
      --shadow: 0 16px 50px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--txt);
      background:
        radial-gradient(1200px 600px at 15% -20%, rgba(124,58,237,.35), transparent 55%),
        radial-gradient(900px 520px at 90% 5%, rgba(34,211,238,.25), transparent 55%),
        radial-gradient(900px 520px at 35% 105%, rgba(34,197,94,.18), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* LOCK BLUR */
    body.is-locked .app{
      filter: blur(10px);
      transform: scale(.995);
      pointer-events:none;
      user-select:none;
      opacity:.75;
    }
    body.is-locked .lockHint{
      display:block;
    }

    .lockHint{
      display:none;
      position:fixed;
      inset:auto 16px 16px auto;
      z-index:30;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--bd);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
      box-shadow: var(--shadow2);
      font-weight:900;
      font-size:12px;
      color: var(--mut);
    }

    .wrap{
      width:min(1180px, 94vw);
      margin: 26px auto 56px;
    }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
      letter-spacing:-.02em;
      font-weight:1000;
      line-height:1.1;
    }
    .brand .sub{
      color: var(--mut);
      font-weight:800;
      font-size:12px;
      line-height:1.5;
    }

    .pillRow{
      display:flex; flex-wrap:wrap; gap:10px;
      justify-content:flex-end;
    }
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--bd);
      background: rgba(255,255,255,.05);
      font-weight:900;
      font-size:12px;
      color: var(--txt);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .pill small{color:var(--mut)}
    .pill .dot{width:10px;height:10px;border-radius:999px;background:rgba(255,255,255,.25)}
    .pill[data-tone="ok"] .dot{background:rgba(34,197,94,.9)}
    .pill[data-tone="warn"] .dot{background:rgba(245,158,11,.95)}
    .pill[data-tone="bad"] .dot{background:rgba(239,68,68,.95)}

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    .card{
      border-radius: var(--r2);
      border:1px solid var(--bd);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card__head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .card__title{
      margin:0;
      font-size:15px;
      font-weight:1000;
      letter-spacing:-.01em;
    }
    .card__meta{
      color:var(--mut);
      font-weight:800;
      font-size:12px;
    }
    .card__body{padding: 14px 16px 16px}

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 520px){
      .row{grid-template-columns:1fr}
    }

    label{
      display:block;
      color: var(--mut);
      font-weight:900;
      font-size:12px;
      margin: 4px 0 8px;
    }
    .input, .textarea, select{
      width:100%;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--txt);
      padding: 12px 12px;
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    .textarea{min-height: 90px; resize: vertical; font-family: var(--mono); font-weight:800}
    .hint{
      margin-top:8px;
      color: var(--mut2);
      font-size:12px;
      line-height:1.5;
      font-weight:800;
    }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .btn{
      border:none;
      border-radius: 16px;
      padding: 12px 14px;
      font-weight:1000;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition: transform .12s ease, filter .12s ease, border-color .12s ease, background .12s ease;
    }
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn--pri{
      color:#07101f;
      background: linear-gradient(90deg, var(--c1), var(--c2));
      box-shadow: 0 12px 28px rgba(34,211,238,.18);
    }
    .btn--ghost{
      color: var(--txt);
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.12);
    }
    .btn--bad{
      color:#24080a;
      background: linear-gradient(90deg, rgba(239,68,68,1), rgba(245,158,11,1));
      box-shadow: 0 12px 28px rgba(239,68,68,.18);
    }
    .btn--mini{padding: 9px 10px; border-radius: 14px; font-size:12px}
    .btn[disabled]{opacity:.55; cursor:not-allowed; transform:none}

    .split{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .kvs{
      display:grid; gap:8px;
      padding: 10px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .kv{display:flex; justify-content:space-between; gap:10px}
    .kv .k{color:var(--mut2); font-weight:900; font-size:12px}
    .kv .v{font-weight:1000; font-size:12px; font-family: var(--mono); text-align:right; color: var(--txt)}

    .codeBox{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.28);
      padding: 12px 12px;
      font-family: var(--mono);
      font-size:12px;
      line-height:1.55;
      white-space: pre;
      overflow:auto;
      max-height: 260px;
    }

    .toast{
      position: fixed;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 40;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      font-weight:1000;
      font-size:12px;
      color: var(--txt);
      display:none;
      max-width: min(760px, 92vw);
      text-align:center;
    }
    .toast.is-on{display:block}

    /* MODAL */
    .modal{
      position:fixed; inset:0;
      z-index:50;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
    }
    .modal.is-on{display:grid}
    .modal__panel{
      width:min(520px, 92vw);
      border-radius: 26px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,13,22,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: in .18s ease both;
    }
    @keyframes in{from{transform: translateY(10px); opacity:0} to{transform:none;opacity:1}}
    .modal__head{
      padding: 14px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modal__title{margin:0; font-weight:1000; font-size:15px}
    .modal__body{padding: 14px 16px 16px}
    .modal__sub{color:var(--mut); font-weight:800; font-size:12px; line-height:1.55; margin-top:6px}
    .tag{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size:12px;
      font-weight:1000;
      color: var(--mut);
      font-family: var(--mono);
    }

    .hr{
      height:1px; background: rgba(255,255,255,.08);
      margin: 12px 0;
    }

    .footer{
      margin-top: 16px;
      color: var(--mut2);
      font-size:12px;
      font-weight:800;
      text-align:center;
    }
    a{color: rgba(34,211,238,.95); text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>

<body class="is-locked">
  <div class="lockHint">ðŸ”’ Admin key belum diisi</div>

  <!-- LOGIN MODAL -->
  <div class="modal is-on" id="keyModal" aria-hidden="false">
    <div class="modal__panel">
      <div class="modal__head">
        <div>
          <h3 class="modal__title">Masuk Admin</h3>
          <div class="modal__sub">Masukkan <b>Admin Key</b> untuk akses endpoint admin di <span class="tag">/api/orkut</span></div>
        </div>
        <button class="btn btn--ghost btn--mini" id="btnFillDemo" type="button" title="Isi contoh (tidak valid)">
          Isi contoh
        </button>
      </div>
      <div class="modal__body">
        <label>Base URL (opsional)</label>
        <input class="input" id="baseUrl" placeholder="Kosong = pakai domain ini (same-origin)" />
        <div class="hint">Kalau admin page ini dibuka dari domain yang sama dengan API, biarin kosong.</div>

        <div class="hr"></div>

        <label>Admin Key</label>
        <input class="input" id="adminKey" placeholder="Masukkan Admin Key..." />
        <div class="hint">
          Key ini akan disimpan di <b>localStorage</b> (browser). Kalau mau logout, klik tombol <b>Logout</b> di kanan atas.
        </div>

        <div class="btnRow">
          <button class="btn btn--pri" id="btnUnlock" type="button">Masuk</button>
          <button class="btn btn--ghost" id="btnPing" type="button">Cek API (ping)</button>
        </div>

        <div class="hr"></div>

        <div class="hint">
          <b>Validasi key:</b> tombol Masuk akan tes request admin ringan (disable voucher code dummy).  
          Jika key salah â†’ status akan <b>401 unauthorized</b>.
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="app">
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <h1>LevPay Admin Panel</h1>
          <div class="sub">
            Target endpoint: <span class="tag" id="tagTarget">/api/orkut</span>
            <span style="opacity:.6">â€¢</span>
            Actions: <span class="tag">admin_upsert_voucher</span> <span class="tag">admin_disable_voucher</span> <span class="tag">admin_set_monthly_promo</span>
          </div>
        </div>

        <div class="pillRow">
          <div class="pill" id="pillApi" data-tone="warn"><span class="dot"></span><span id="pillApiText">API: belum dicek</span></div>
          <div class="pill" id="pillKey" data-tone="warn"><span class="dot"></span><span id="pillKeyText">Key: belum</span></div>
          <button class="btn btn--ghost btn--mini" id="btnLogout" type="button">Logout</button>
        </div>
      </div>

      <div class="grid">
        <!-- LEFT -->
        <div class="card">
          <div class="card__head">
            <h3 class="card__title">Voucher</h3>
            <div class="card__meta">Buat / update / nonaktifin voucher</div>
          </div>
          <div class="card__body">
            <div class="row">
              <div>
                <label>Kode Voucher (wajib)</label>
                <input class="input" id="vCode" placeholder="Contoh: VIPL" />
              </div>
              <div>
                <label>Nama (opsional)</label>
                <input class="input" id="vName" placeholder="Contoh: VIP LEVEL" />
              </div>

              <div>
                <label>Diskon % (wajib)</label>
                <input class="input" id="vPercent" type="number" min="0" max="100" step="1" placeholder="Contoh: 60" />
                <div class="hint">Kalau % kamu 90 tapi kepotongnya kecil, biasanya <b>maxRp</b> kepasang.</div>
              </div>

              <div>
                <label>Max Potongan (Rp) (opsional, default 0 = unlimited)</label>
                <input class="input" id="vMaxRp" type="number" min="0" step="1" placeholder="0" />
              </div>

              <div>
                <label>Max Uses (opsional)</label>
                <input class="input" id="vMaxUses" type="number" min="1" step="1" placeholder="Kosong = unlimited" />
                <div class="hint"><b>Penting:</b> Jangan kirim string kosong jadi 0. Panel ini otomatis <b>omit</b> kalau kosong.</div>
              </div>

              <div>
                <label>Expired At (opsional)</label>
                <input class="input" id="vExpiresAt" type="datetime-local" />
                <div class="hint">Kalau kosong â†’ tidak ada expiry.</div>
              </div>
            </div>

            <div style="margin-top:10px" class="split">
              <div>
                <label style="margin:0 0 8px">Status</label>
                <div class="kvs">
                  <div class="kv"><span class="k">Enabled</span><span class="v"><input id="vEnabled" type="checkbox" checked /></span></div>
                  <div class="kv"><span class="k">Note</span><span class="v">opsional</span></div>
                </div>
              </div>
              <div style="flex:1">
                <label>Note (opsional)</label>
                <textarea class="textarea" id="vNote" placeholder="Catatan internal... (opsional)"></textarea>
              </div>
            </div>

            <div class="btnRow">
              <button class="btn btn--pri" id="btnUpsertVoucher" type="button">Upsert Voucher</button>
              <button class="btn btn--bad" id="btnDisableVoucher" type="button">Disable Voucher</button>
              <button class="btn btn--ghost" id="btnFillVoucherDemo" type="button">Isi Contoh (VIPL)</button>
            </div>

            <div class="hr"></div>

            <h3 class="card__title" style="margin:0 0 10px">Test Voucher (tanpa admin)</h3>
            <div class="row">
              <div>
                <label>Amount</label>
                <input class="input" id="tAmount" type="number" min="1" step="1" value="10000" />
              </div>
              <div>
                <label>Device ID</label>
                <input class="input" id="tDeviceId" placeholder="Contoh: dev_web_abc123" />
              </div>
              <div>
                <label>Voucher Code</label>
                <input class="input" id="tVoucher" placeholder="Contoh: VIPL" />
              </div>
              <div>
                <label>&nbsp;</label>
                <button class="btn btn--ghost" id="btnGenDeviceId" type="button" style="width:100%">Generate Device ID</button>
              </div>
            </div>
            <div class="btnRow">
              <button class="btn btn--pri" id="btnTestCreateQR" type="button">Test via createqr</button>
              <button class="btn btn--ghost" id="btnCopyCurlCreateQR" type="button">Copy curl createqr</button>
            </div>
            <div class="hint">
              Ini ngetes ke: <span class="tag">/api/orkut?action=createqr</span>  
              Output bakal nampilin <b>pricing</b> yang dipake (amountOriginal/amountFinal/discountRp/applied).
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div style="display:grid; gap:16px">
          <div class="card">
            <div class="card__head">
              <h3 class="card__title">Monthly Promo</h3>
              <div class="card__meta">1Ã— per device per bulan + unlimited deviceKey</div>
            </div>
            <div class="card__body">
              <div class="row">
                <div>
                  <label>Enabled</label>
                  <select id="mEnabled" class="input">
                    <option value="true">true</option>
                    <option value="false">false</option>
                  </select>
                </div>
                <div>
                  <label>Nama Promo</label>
                  <input class="input" id="mName" placeholder="PROMO BULANAN" />
                </div>
                <div>
                  <label>Diskon %</label>
                  <input class="input" id="mPercent" type="number" min="0" max="100" step="1" placeholder="5" />
                </div>
                <div>
                  <label>Max Rp</label>
                  <input class="input" id="mMaxRp" type="number" min="0" step="1" placeholder="2000" />
                </div>
              </div>

              <div class="btnRow">
                <button class="btn btn--pri" id="btnSetMonthly" type="button">Simpan Monthly</button>
                <button class="btn btn--ghost" id="btnFillMonthlyDemo" type="button">Isi Contoh</button>
                <button class="btn btn--ghost" id="btnCopyCurlMonthly" type="button">Copy curl monthly</button>
              </div>

              <div class="hr"></div>

              <h3 class="card__title" style="margin:0 0 10px">Unlimited Device</h3>
              <div class="hint">
                Endpoint butuh <b>deviceKey</b> (bukan deviceId). deviceKey = SHA256(<span class="tag">deviceId + "|" + pepper</span>)  
                Pepper = <b>DEVICE_PEPPER</b> di server (env). Masukin pepper yang kamu pake di Vercel.
              </div>

              <div class="row" style="margin-top:10px">
                <div>
                  <label>Device ID</label>
                  <input class="input" id="uDeviceId" placeholder="dev_xxx" />
                </div>
                <div>
                  <label>Pepper (DEVICE_PEPPER)</label>
                  <input class="input" id="uPepper" placeholder="Isi pepper server..." />
                </div>
                <div>
                  <label>Hasil deviceKey (SHA256)</label>
                  <input class="input" id="uDeviceKey" placeholder="(klik Generate)" readonly />
                </div>
                <div>
                  <label>&nbsp;</label>
                  <button class="btn btn--ghost" id="btnGenDeviceKey" type="button" style="width:100%">Generate deviceKey</button>
                </div>
              </div>

              <div class="btnRow">
                <button class="btn btn--pri" id="btnAddUnlimited" type="button">Add Unlimited</button>
                <button class="btn btn--bad" id="btnRemoveUnlimited" type="button">Remove Unlimited</button>
                <button class="btn btn--ghost" id="btnCopyCurlUnlimited" type="button">Copy curl unlimited</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card__head">
              <h3 class="card__title">Output / Log</h3>
              <div class="card__meta">Hasil response JSON (biar gampang debug)</div>
            </div>
            <div class="card__body">
              <div class="btnRow" style="margin-top:0">
                <button class="btn btn--ghost btn--mini" id="btnPingTop" type="button">Ping</button>
                <button class="btn btn--ghost btn--mini" id="btnCopyLog" type="button">Copy Log</button>
                <button class="btn btn--ghost btn--mini" id="btnClearLog" type="button">Clear</button>
              </div>
              <div class="codeBox" id="logBox">{}</div>

              <div class="hr"></div>

              <h3 class="card__title" style="margin:0 0 10px">Cheat Sheet curl</h3>
              <div class="hint">Klik tombol copy di bagian masing-masing, atau copy template di bawah.</div>
              <div class="codeBox" id="curlBox"></div>

              <div class="footer">
                Kalau voucher di admin <b>aktif</b> tapi di frontend gak kepotong:
                pastiin admin page nembak ke endpoint yang sama dengan frontend, dan payload <b>tidak ngirim</b> <code>maxUses:""</code> / <code>percent:"90%"</code> (harus angka).
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- wrap -->
  </div><!-- app -->

  <div class="toast" id="toast">OK</div>

  <script>
    (function(){
      const $ = (id)=>document.getElementById(id);

      // modal elements
      const keyModal = $("keyModal");
      const baseUrlEl = $("baseUrl");
      const adminKeyEl = $("adminKey");
      const btnUnlock = $("btnUnlock");
      const btnPing = $("btnPing");
      const btnFillDemo = $("btnFillDemo");

      // top
      const btnLogout = $("btnLogout");
      const pillApi = $("pillApi");
      const pillApiText = $("pillApiText");
      const pillKey = $("pillKey");
      const pillKeyText = $("pillKeyText");
      const tagTarget = $("tagTarget");

      // voucher form
      const vCode = $("vCode");
      const vName = $("vName");
      const vPercent = $("vPercent");
      const vMaxRp = $("vMaxRp");
      const vMaxUses = $("vMaxUses");
      const vExpiresAt = $("vExpiresAt");
      const vEnabled = $("vEnabled");
      const vNote = $("vNote");

      const btnUpsertVoucher = $("btnUpsertVoucher");
      const btnDisableVoucher = $("btnDisableVoucher");
      const btnFillVoucherDemo = $("btnFillVoucherDemo");

      // test createqr
      const tAmount = $("tAmount");
      const tDeviceId = $("tDeviceId");
      const tVoucher = $("tVoucher");
      const btnGenDeviceId = $("btnGenDeviceId");
      const btnTestCreateQR = $("btnTestCreateQR");
      const btnCopyCurlCreateQR = $("btnCopyCurlCreateQR");

      // monthly
      const mEnabled = $("mEnabled");
      const mName = $("mName");
      const mPercent = $("mPercent");
      const mMaxRp = $("mMaxRp");
      const btnSetMonthly = $("btnSetMonthly");
      const btnFillMonthlyDemo = $("btnFillMonthlyDemo");
      const btnCopyCurlMonthly = $("btnCopyCurlMonthly");

      // unlimited
      const uDeviceId = $("uDeviceId");
      const uPepper = $("uPepper");
      const uDeviceKey = $("uDeviceKey");
      const btnGenDeviceKey = $("btnGenDeviceKey");
      const btnAddUnlimited = $("btnAddUnlimited");
      const btnRemoveUnlimited = $("btnRemoveUnlimited");
      const btnCopyCurlUnlimited = $("btnCopyCurlUnlimited");

      // log
      const logBox = $("logBox");
      const curlBox = $("curlBox");
      const btnPingTop = $("btnPingTop");
      const btnCopyLog = $("btnCopyLog");
      const btnClearLog = $("btnClearLog");

      // storage keys
      const LS_KEY = "levpay_admin_key";
      const LS_BASE = "levpay_admin_base";

      // state
      let ADMIN_KEY = "";
      let BASE = "";

      function toast(msg){
        const el = $("toast");
        el.textContent = msg;
        el.classList.add("is-on");
        clearTimeout(el._t);
        el._t = setTimeout(()=>el.classList.remove("is-on"), 1800);
      }

      function setPill(el, tone, text){
        el.dataset.tone = tone;
        el.querySelector("span:last-child").textContent = text;
      }

      function apiBase(){
        const b = String(BASE || "").trim().replace(/\/+$/,"");
        return b; // empty = same origin
      }

      function endpoint(action){
        return apiBase() + "/api/orkut?action=" + encodeURIComponent(action);
      }

      function jsonPretty(x){
        try { return JSON.stringify(x, null, 2); } catch { return String(x); }
      }

      function log(obj){
        logBox.textContent = jsonPretty(obj);
      }

      function currentCurlTemplates(){
        const host = apiBase() || "$HOST";
        const key = "$ADMIN_KEY";
        return [
`# Set host (Termux / bash)
HOST="${host || "https://levpay-api.vercel.app"}"

# 1) PING
curl -sS "$HOST/api/orkut?action=ping" | jq

# 2) UPSERT VOUCHER (ADMIN)
curl -sS -X POST "$HOST/api/orkut?action=admin_upsert_voucher" \\
  -H "Content-Type: application/json" \\
  -H "X-Admin-Key: ${key}" \\
  -d '{"code":"VIPL","name":"VIP LEVEL","enabled":true,"percent":60,"maxRp":0,"note":"contoh"}' | jq

# 3) DISABLE VOUCHER (ADMIN)
curl -sS -X POST "$HOST/api/orkut?action=admin_disable_voucher" \\
  -H "Content-Type: application/json" \\
  -H "X-Admin-Key: ${key}" \\
  -d '{"code":"VIPL"}' | jq

# 4) SET MONTHLY PROMO (ADMIN)
curl -sS -X POST "$HOST/api/orkut?action=admin_set_monthly_promo" \\
  -H "Content-Type: application/json" \\
  -H "X-Admin-Key: ${key}" \\
  -d '{"enabled":true,"name":"PROMO BULANAN","percent":5,"maxRp":2000}' | jq

# 5) ADD UNLIMITED DEVICEKEY (ADMIN)
curl -sS -X POST "$HOST/api/orkut?action=admin_set_monthly_promo" \\
  -H "Content-Type: application/json" \\
  -H "X-Admin-Key: ${key}" \\
  -d '{"addUnlimitedDeviceKey":"<SHA256(deviceId|pepper)>"}' | jq

# 6) TEST CREATEQR (NO ADMIN)
curl -sS -X POST "$HOST/api/orkut?action=createqr" \\
  -H "Content-Type: application/json" \\
  -d '{"amount":10000,"deviceId":"dev_web_1","voucher":"VIPL"}' | jq

# 7) STATUS (NO ADMIN)
curl -sS "$HOST/api/orkut?action=status&idTransaksi=<ID>" | jq

# 8) CANCEL (NO ADMIN)
curl -sS -X POST "$HOST/api/orkut?action=cancel" \\
  -H "Content-Type: application/json" \\
  -d '{"idTransaksi":"<ID>"}' | jq
`
        ].join("\n");
      }

      function refreshCurlBox(){
        curlBox.textContent = currentCurlTemplates();
      }

      async function jfetch(url, opts){
        const r = await fetch(url, opts);
        const text = await r.text();
        let json = null;
        try { json = text ? JSON.parse(text) : {}; } catch { json = { raw: text }; }
        return { ok: r.ok, status: r.status, json };
      }

      async function ping(){
        const url = endpoint("ping");
        const res = await jfetch(url, { method:"GET" });
        if (res.ok){
          setPill(pillApi, "ok", "API: OK");
          toast("Ping OK");
        } else {
          setPill(pillApi, "bad", "API: ERROR");
          toast("Ping ERROR");
        }
        log({ action:"ping", url, ...res });
        return res;
      }

      function lockUI(locked){
        document.body.classList.toggle("is-locked", !!locked);
        keyModal.classList.toggle("is-on", !!locked);
        keyModal.setAttribute("aria-hidden", locked ? "false" : "true");
      }

      function sanitizeCode(s){
        return String(s||"").trim().toUpperCase().replace(/\s+/g,"");
      }

      function toIsoFromDatetimeLocal(v){
        const s = String(v||"").trim();
        if (!s) return null;
        const d = new Date(s);
        if (!Number.isFinite(d.getTime())) return null;
        return d.toISOString();
      }

      function maybeNumber(v){
        const s = String(v ?? "").trim();
        if (s === "") return undefined; // IMPORTANT: omit empty
        const n = Number(s);
        return Number.isFinite(n) ? n : undefined;
      }

      function buildVoucherPayload(){
        const code = sanitizeCode(vCode.value);
        const percent = maybeNumber(vPercent.value);
        if (!code) throw new Error("code wajib");
        if (percent == null) throw new Error("percent wajib (angka)");

        const payload = {
          code,
          percent,
          enabled: !!vEnabled.checked,
        };

        const name = String(vName.value||"").trim();
        const note = String(vNote.value||"").trim();

        const maxRp = maybeNumber(vMaxRp.value);
        const maxUses = maybeNumber(vMaxUses.value);

        const expiresAt = toIsoFromDatetimeLocal(vExpiresAt.value);

        if (name) payload.name = name;
        if (note) payload.note = note;

        // maxRp: default 0 = unlimited potongan (server akan clamp)
        // kalau input kosong -> jangan kirim (biar server default)
        if (maxRp != null) payload.maxRp = maxRp;

        // maxUses: kalau kosong jangan kirim (ini yang sering bikin maxUses=0)
        if (maxUses != null) payload.maxUses = maxUses;

        if (expiresAt) payload.expiresAt = expiresAt;

        return payload;
      }

      async function adminValidateKey(){
        // trick: panggil disable voucher code dummy
        // - kalau key salah => 401
        // - kalau key bener => biasanya 500 "voucher not found" (tetep berarti authorized)
        const url = endpoint("admin_disable_voucher");
        const res = await jfetch(url, {
          method:"POST",
          headers: {
            "Content-Type":"application/json",
            "X-Admin-Key": ADMIN_KEY
          },
          body: JSON.stringify({ code: "__VALIDATE__" })
        });

        if (res.status === 401){
          setPill(pillKey, "bad", "Key: salah");
          return { ok:false, reason:"unauthorized", res };
        }

        // 200 => key valid (kalau kebetulan voucher __VALIDATE__ ada)
        // 500 => key valid tapi voucher not found
        setPill(pillKey, "ok", "Key: OK");
        return { ok:true, res };
      }

      async function upsertVoucher(){
        const payload = buildVoucherPayload();
        const url = endpoint("admin_upsert_voucher");
        const res = await jfetch(url, {
          method:"POST",
          headers: {
            "Content-Type":"application/json",
            "X-Admin-Key": ADMIN_KEY
          },
          body: JSON.stringify(payload)
        });
        log({ action:"admin_upsert_voucher", url, payload, ...res });
        if (!res.ok){
          toast("Upsert gagal (" + res.status + ")");
          return;
        }
        toast("Voucher di-upsert âœ…");
      }

      async function disableVoucher(){
        const code = sanitizeCode(vCode.value);
        if (!code) { toast("Isi code dulu"); return; }
        const ok = confirm("Disable voucher: " + code + " ?");
        if (!ok) return;

        const url = endpoint("admin_disable_voucher");
        const payload = { code };
        const res = await jfetch(url, {
          method:"POST",
          headers: {
            "Content-Type":"application/json",
            "X-Admin-Key": ADMIN_KEY
          },
          body: JSON.stringify(payload)
        });
        log({ action:"admin_disable_voucher", url, payload, ...res });
        if (!res.ok){
          toast("Disable gagal (" + res.status + ")");
          return;
        }
        toast("Voucher di-disable âœ…");
      }

      function buildMonthlyPayload(){
        const payload = {};
        payload.enabled = (String(mEnabled.value) === "true");
        const name = String(mName.value||"").trim();
        const percent = maybeNumber(mPercent.value);
        const maxRp = maybeNumber(mMaxRp.value);

        if (name) payload.name = name;
        if (percent != null) payload.percent = percent;
        if (maxRp != null) payload.maxRp = maxRp;
        return payload;
      }

      async function setMonthly(){
        const payload = buildMonthlyPayload();
        const url = endpoint("admin_set_monthly_promo");
        const res = await jfetch(url, {
          method:"POST",
          headers: {
            "Content-Type":"application/json",
            "X-Admin-Key": ADMIN_KEY
          },
          body: JSON.stringify(payload)
        });
        log({ action:"admin_set_monthly_promo", url, payload, ...res });
        if (!res.ok){
          toast("Set monthly gagal (" + res.status + ")");
          return;
        }
        toast("Monthly tersimpan âœ…");
      }

      async function setUnlimited(mode){
        const dk = String(uDeviceKey.value||"").trim();
        if (!dk){ toast("Generate deviceKey dulu"); return; }

        const payload = (mode === "add")
          ? { addUnlimitedDeviceKey: dk }
          : { removeUnlimitedDeviceKey: dk };

        const url = endpoint("admin_set_monthly_promo");
        const res = await jfetch(url, {
          method:"POST",
          headers: {
            "Content-Type":"application/json",
            "X-Admin-Key": ADMIN_KEY
          },
          body: JSON.stringify(payload)
        });
        log({ action:"admin_set_monthly_promo (unlimited)", url, payload, ...res });
        if (!res.ok){
          toast("Gagal (" + res.status + ")");
          return;
        }
        toast((mode==="add" ? "Added" : "Removed") + " unlimited âœ…");
      }

      function genDeviceId(){
        const rnd = Math.random().toString(36).slice(2, 8);
        const rnd2 = Math.random().toString(36).slice(2, 8);
        return "dev_web_" + rnd + "_" + rnd2;
      }

      async function sha256Hex(str){
        const enc = new TextEncoder().encode(str);
        const buf = await crypto.subtle.digest("SHA-256", enc);
        const arr = Array.from(new Uint8Array(buf));
        return arr.map(b => b.toString(16).padStart(2,"0")).join("");
      }

      async function genDeviceKey(){
        const did = String(uDeviceId.value||"").trim();
        const pep = String(uPepper.value||"").trim();
        if (!did || !pep){ toast("Isi deviceId & pepper dulu"); return; }
        const key = await sha256Hex(did + "|" + pep);
        uDeviceKey.value = key;
        toast("deviceKey dibuat");
      }

      async function testCreateQR(){
        const amount = Number(String(tAmount.value||"").trim());
        const deviceId = String(tDeviceId.value||"").trim();
        const voucher = String(tVoucher.value||"").trim();

        if (!Number.isFinite(amount) || amount < 1){ toast("Amount invalid"); return; }
        if (!deviceId){ toast("Device ID wajib"); return; }

        const url = endpoint("createqr");
        const payload = { amount, deviceId, voucher };
        const res = await jfetch(url, {
          method:"POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        log({ action:"createqr", url, payload, ...res });

        if (!res.ok){
          toast("Test gagal (" + res.status + ")");
          return;
        }

        // quick highlight
        const pricing = res.json?.pricing || res.json?.data?.pricing || null;
        if (pricing){
          const applied = pricing.applied || [];
          toast("OK â€¢ discountRp: " + (pricing.discountRp ?? 0) + " â€¢ applied: " + (applied.length ? applied.map(x=>x.code||x.name||x.type).join(",") : "-"));
        } else {
          toast("OK (lihat log)");
        }
      }

      function copy(text){
        return navigator.clipboard.writeText(String(text||""))
          .then(()=>toast("Copied âœ…"))
          .catch(()=>toast("Copy gagal"));
      }

      function curlCreateQR(){
        const host = apiBase() || "$HOST";
        const amount = Number(String(tAmount.value||"10000").trim()) || 10000;
        const deviceId = String(tDeviceId.value||"dev_web_1").trim() || "dev_web_1";
        const voucher = String(tVoucher.value||"VIPL").trim();
        const payload = { amount, deviceId, voucher };
        return `HOST="${host || "https://levpay-api.vercel.app"}"\n` +
`curl -sS -X POST "$HOST/api/orkut?action=createqr" \\\n` +
`  -H "Content-Type: application/json" \\\n` +
`  -d '${JSON.stringify(payload)}' | jq\n`;
      }

      function curlMonthly(){
        const host = apiBase() || "$HOST";
        const key = "$ADMIN_KEY";
        const payload = buildMonthlyPayload();
        return `HOST="${host || "https://levpay-api.vercel.app"}"\n` +
`curl -sS -X POST "$HOST/api/orkut?action=admin_set_monthly_promo" \\\n` +
`  -H "Content-Type: application/json" \\\n` +
`  -H "X-Admin-Key: ${key}" \\\n` +
`  -d '${JSON.stringify(payload)}' | jq\n`;
      }

      function curlUnlimited(){
        const host = apiBase() || "$HOST";
        const key = "$ADMIN_KEY";
        const dk = String(uDeviceKey.value||"<SHA256(deviceId|pepper)>").trim() || "<SHA256(deviceId|pepper)>";
        const payload = { addUnlimitedDeviceKey: dk };
        return `HOST="${host || "https://levpay-api.vercel.app"}"\n` +
`curl -sS -X POST "$HOST/api/orkut?action=admin_set_monthly_promo" \\\n` +
`  -H "Content-Type: application/json" \\\n` +
`  -H "X-Admin-Key: ${key}" \\\n` +
`  -d '${JSON.stringify(payload)}' | jq\n`;
      }

      function loadSaved(){
        BASE = localStorage.getItem(LS_BASE) || "";
        ADMIN_KEY = localStorage.getItem(LS_KEY) || "";

        baseUrlEl.value = BASE;
        adminKeyEl.value = ADMIN_KEY ? "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" : "";

        tagTarget.textContent = (apiBase() ? apiBase() : "") + "/api/orkut";
        refreshCurlBox();

        if (ADMIN_KEY){
          lockUI(false);
          setPill(pillKey, "warn", "Key: tersimpan");
          setTimeout(async ()=>{
            await ping();
            const v = await adminValidateKey();
            if (!v.ok){
              toast("Admin key salah. Login ulang.");
              doLogout();
            }
          }, 60);
        } else {
          lockUI(true);
          setPill(pillKey, "warn", "Key: belum");
        }
      }

      async function doUnlock(){
        BASE = String(baseUrlEl.value||"").trim();
        localStorage.setItem(LS_BASE, BASE);

        // ambil admin key dari input (kalau masked, pake last saved)
        const rawKey = String($("adminKey").value||"").trim();
        if (rawKey && rawKey !== "â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢") ADMIN_KEY = rawKey;

        if (!ADMIN_KEY){
          toast("Admin key wajib");
          return;
        }

        localStorage.setItem(LS_KEY, ADMIN_KEY);
        tagTarget.textContent = (apiBase() ? apiBase() : "") + "/api/orkut";
        refreshCurlBox();

        // ping dulu
        await ping();

        // validate key
        const v = await adminValidateKey();
        log({ action:"validate", ...v });

        if (!v.ok){
          toast("Admin key salah (401).");
          return;
        }

        lockUI(false);
        toast("Masuk âœ…");
      }

      function doLogout(){
        ADMIN_KEY = "";
        localStorage.removeItem(LS_KEY);
        setPill(pillKey, "warn", "Key: belum");
        lockUI(true);
      }

      // events
      btnUnlock.addEventListener("click", doUnlock);
      btnPing.addEventListener("click", ping);
      btnPingTop.addEventListener("click", ping);
      btnLogout.addEventListener("click", ()=>{
        if (confirm("Logout?")) doLogout();
      });

      btnFillDemo.addEventListener("click", ()=>{
        baseUrlEl.value = "";
        adminKeyEl.value = "CONTOH_KEY";
        toast("Ini cuma contoh, bukan key beneran");
      });

      btnUpsertVoucher.addEventListener("click", async ()=>{
        try{
          const v = await adminValidateKey();
          if (!v.ok){ toast("Key salah / belum login"); return; }
          await upsertVoucher();
        }catch(e){
          toast(e.message || "error");
        }
      });

      btnDisableVoucher.addEventListener("click", async ()=>{
        try{
          const v = await adminValidateKey();
          if (!v.ok){ toast("Key salah / belum login"); return; }
          await disableVoucher();
        }catch(e){
          toast(e.message || "error");
        }
      });

      btnFillVoucherDemo.addEventListener("click", ()=>{
        vCode.value = "VIPL";
        vName.value = "VIP LEVEL";
        vPercent.value = "90";
        vMaxRp.value = "0";
        vMaxUses.value = ""; // important: blank means omit
        vExpiresAt.value = "";
        vEnabled.checked = true;
        vNote.value = "Diskon VIP (contoh)";
        tVoucher.value = "VIPL";
        toast("Contoh terisi");
      });

      btnFillMonthlyDemo.addEventListener("click", ()=>{
        mEnabled.value = "true";
        mName.value = "PROMO BULANAN";
        mPercent.value = "5";
        mMaxRp.value = "2000";
        toast("Monthly contoh terisi");
      });

      btnSetMonthly.addEventListener("click", async ()=>{
        const v = await adminValidateKey();
        if (!v.ok){ toast("Key salah / belum login"); return; }
        await setMonthly();
      });

      btnGenDeviceId.addEventListener("click", ()=>{
        const id = genDeviceId();
        tDeviceId.value = id;
        uDeviceId.value = id;
        toast("Device ID dibuat");
      });

      btnTestCreateQR.addEventListener("click", testCreateQR);

      btnCopyCurlCreateQR.addEventListener("click", ()=>copy(curlCreateQR()));
      btnCopyCurlMonthly.addEventListener("click", ()=>copy(curlMonthly()));
      btnCopyCurlUnlimited.addEventListener("click", ()=>copy(curlUnlimited()));

      btnGenDeviceKey.addEventListener("click", genDeviceKey);
      btnAddUnlimited.addEventListener("click", async ()=>{
        const v = await adminValidateKey();
        if (!v.ok){ toast("Key salah / belum login"); return; }
        await setUnlimited("add");
      });
      btnRemoveUnlimited.addEventListener("click", async ()=>{
        const v = await adminValidateKey();
        if (!v.ok){ toast("Key salah / belum login"); return; }
        await setUnlimited("remove");
      });

      btnCopyLog.addEventListener("click", ()=>copy(logBox.textContent));
      btnClearLog.addEventListener("click", ()=>{ logBox.textContent="{}"; toast("Cleared"); });
      $("btnCopyCurlUnlimited").addEventListener("dblclick", ()=>copy(curlBox.textContent)); // bonus

      // init
      loadSaved();
      refreshCurlBox();

      // prefill device id for tester
      if (!tDeviceId.value) tDeviceId.value = genDeviceId();
      if (!uDeviceId.value) uDeviceId.value = tDeviceId.value;
      if (!mName.value) mName.value = "PROMO BULANAN";

    })();
  </script>
</body>
</html>